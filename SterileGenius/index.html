<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STERILE GENIUS 2.0: Sterilization Matchmaker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            position: fixed; left: 0; top: 0;
            width: 300px; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
            padding: 24px 20px;
            overflow-y: auto; z-index: 100;
        }

        .btn-home {
            display: flex; align-items: center; gap: 8px;
            width: 100%; padding: 10px 16px;
            background: #f1f5f9; color: #475569;
            border: 1.5px solid #e2e8f0; border-radius: 10px;
            font-size: 13px; font-weight: 600;
            cursor: pointer; text-decoration: none;
            transition: all 0.2s ease; margin-bottom: 16px;
        }
        .btn-home:hover { background: #e2e8f0; color: #1e293b; transform: translateX(-2px); }

        .logo {
            font-size: 24px; font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 4px;
        }
        .tagline { font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 16px; font-style: italic; }

        .difficulty-badge {
            display: inline-block; padding: 6px 14px; border-radius: 20px;
            font-size: 11px; font-weight: 700; margin-bottom: 16px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .difficulty-foundational { background: #dbeafe; color: #1e40af; }
        .difficulty-intermediate { background: #fef3c7; color: #92400e; }
        .difficulty-advanced { background: #fecaca; color: #991b1b; }

        /* Round tracker in sidebar */
        .round-tracker { margin-bottom: 16px; }
        .round-track-title {
            font-size: 11px; font-weight: 700; color: #94a3b8;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .round-row {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; border-radius: 10px;
            margin-bottom: 6px; background: #f8fafc;
            border: 1.5px solid transparent; transition: all 0.2s;
        }
        .round-row.active { background: #ede9fe; border-color: #a78bfa; }
        .round-row.done { background: #dcfce7; border-color: #86efac; }
        .round-icon { font-size: 16px; flex-shrink: 0; }
        .round-info { flex: 1; }
        .round-name { font-size: 12px; font-weight: 700; color: #1e293b; }
        .round-desc { font-size: 11px; color: #64748b; }
        .round-status { font-size: 11px; font-weight: 700; }
        .status-not-started { color: #94a3b8; }
        .status-in-progress { color: #7c3aed; }
        .status-done { color: #16a34a; }

        .stats-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 14px; padding: 16px; margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .stat-row:last-child { margin-bottom: 0; }
        .stat-label { font-size: 12px; color: #475569; font-weight: 500; }
        .stat-value { font-size: 16px; font-weight: 700; color: #1e293b; }

        .progress-bar-container {
            background: rgba(255,255,255,0.6); border-radius: 8px;
            height: 7px; overflow: hidden; margin-top: 6px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px; transition: width 0.3s ease;
        }

        .btn-new-session {
            width: 100%; padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            margin-bottom: 12px;
        }
        .btn-new-session:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-new-session:active { transform: translateY(0); }

        .info-section { background: rgba(249,250,251,0.6); border-radius: 10px; padding: 14px; margin-top: 12px; }
        .info-title { font-size: 11px; font-weight: 700; color: #1e293b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-text { font-size: 12px; color: #64748b; line-height: 1.6; }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: 300px; padding: 40px;
            min-height: 100vh; display: flex;
            align-items: center; justify-content: center;
        }
        .game-container { max-width: 680px; width: 100%; }

        /* Round Banner */
        .round-banner {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; margin-bottom: 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 16px; padding: 14px 24px;
            backdrop-filter: blur(10px);
        }
        .round-banner-icon { font-size: 28px; }
        .round-banner-text { color: white; }
        .round-banner-title { font-size: 20px; font-weight: 800; }
        .round-banner-subtitle { font-size: 13px; opacity: 0.85; }

        /* ========== DEVICE CARD ========== */
        .device-card {
            background: white; border-radius: 24px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            margin-bottom: 0; position: relative; transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        .device-card.correct-answer { animation: correctPulse 0.6s ease; border-color: #10b981; }
        .device-card.wrong-answer { animation: wrongShake 0.5s ease; border-color: #ef4444; }

        @keyframes correctPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.015)} }
        @keyframes wrongShake {
            0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-8px)}
            20%,40%,60%,80%{transform:translateX(8px)}
        }

        .difficulty-tag {
            display: inline-block; padding: 5px 10px; border-radius: 7px;
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 14px;
        }
        .tag-foundational { background: #dbeafe; color: #1e40af; }
        .tag-intermediate { background: #fef3c7; color: #92400e; }
        .tag-advanced { background: #fecaca; color: #991b1b; }

        .device-name { font-size: 26px; font-weight: 800; color: #1e293b; margin-bottom: 10px; line-height: 1.3; }
        .device-description { font-size: 14px; color: #64748b; line-height: 1.6; margin-bottom: 20px; }

        .materials-section { background: #f8fafc; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
        .materials-row { display: flex; align-items: flex-start; margin-bottom: 7px; }
        .materials-row:last-child { margin-bottom: 0; }
        .materials-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; width: 90px; flex-shrink: 0; }
        .materials-value { font-size: 13px; font-weight: 600; color: #334155; flex: 1; }

        .method-section { margin-top: 24px; }
        .method-question { font-size: 17px; font-weight: 700; color: #1e293b; text-align: center; margin-bottom: 20px; }

        /* ========== SWIPE MODE (Round 1) ========== */
        #swipeMode .current-method {
            display: block; padding: 18px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 14px; font-size: 20px; font-weight: 800;
            margin-bottom: 28px; box-shadow: 0 8px 24px rgba(102,126,234,0.3);
            text-align: center;
        }
        .swipe-buttons { display: flex; gap: 24px; justify-content: center; margin-bottom: 20px; }
        .swipe-btn {
            width: 110px; height: 110px; border-radius: 50%; border: none;
            font-size: 44px; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .swipe-btn::before {
            content:''; position:absolute; top:50%; left:50%;
            width:0; height:0; border-radius:50%;
            background:rgba(255,255,255,0.3);
            transform:translate(-50%,-50%); transition: width 0.5s, height 0.5s;
        }
        .swipe-btn:active::before { width: 280px; height: 280px; }
        .swipe-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }
        .btn-incompatible { background: linear-gradient(135deg,#ef4444,#dc2626); box-shadow: 0 8px 24px rgba(239,68,68,0.3); color: white; }
        .btn-incompatible:hover:not(:disabled) { transform: scale(1.1) rotate(-5deg); box-shadow: 0 12px 32px rgba(239,68,68,0.4); }
        .btn-compatible { background: linear-gradient(135deg,#10b981,#059669); box-shadow: 0 8px 24px rgba(16,185,129,0.3); color: white; }
        .btn-compatible:hover:not(:disabled) { transform: scale(1.1) rotate(5deg); box-shadow: 0 12px 32px rgba(16,185,129,0.4); }
        .swipe-labels { display: flex; gap: 24px; justify-content: center; margin-bottom: 24px; }
        .swipe-label { width: 110px; text-align: center; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .label-incompatible { color: #ef4444; }
        .label-compatible { color: #10b981; }

        /* ========== PICK MODE (Round 2 & 3) ========== */
        #pickMode .pick-prompt {
            font-size: 17px; font-weight: 700; color: #1e293b;
            text-align: center; margin-bottom: 20px;
        }
        #pickMode .pick-context {
            background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
            border-radius: 12px; padding: 14px 18px;
            font-size: 13px; color: #334155; line-height: 1.6;
            margin-bottom: 20px; display: none;
        }
        #pickMode .pick-context.show { display: block; }
        .method-options {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-bottom: 8px;
        }
        .method-option-btn {
            padding: 14px 12px;
            background: white; border: 2px solid #e2e8f0;
            border-radius: 12px; font-size: 13px; font-weight: 600;
            color: #334155; cursor: pointer; transition: all 0.2s ease;
            text-align: center; line-height: 1.4;
        }
        .method-option-btn:hover:not(:disabled) {
            border-color: #667eea; color: #667eea;
            background: #f0f4ff; transform: translateY(-1px);
        }
        .method-option-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .method-option-btn.selected-correct { border-color: #10b981 !important; background: #dcfce7 !important; color: #065f46 !important; }
        .method-option-btn.selected-wrong { border-color: #ef4444 !important; background: #fee2e2 !important; color: #991b1b !important; }
        .method-option-btn.reveal-correct { border-color: #10b981 !important; background: #dcfce7 !important; color: #065f46 !important; }

        /* ========== HINT ========== */
        .hint-section { text-align: center; margin-top: 12px; }
        .btn-hint {
            background: transparent; border: 2px solid #cbd5e1;
            color: #64748b; padding: 8px 18px; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-hint:hover { border-color: #667eea; color: #667eea; background: rgba(102,126,234,0.05); }
        .btn-hint:disabled { opacity: 0.3; cursor: not-allowed; }
        .hint-display {
            margin-top: 10px; padding: 10px 14px; background: #fef3c7;
            border-radius: 8px; font-size: 12px; color: #92400e; font-weight: 500;
            display: none; border-left: 4px solid #f59e0b; text-align: left;
        }
        .hint-display.show { display: block; animation: slideIn 0.3s ease; }

        /* ========== FEEDBACK ========== */
        .feedback-area {
            background: #f8fafc; border-radius: 14px; padding: 22px;
            margin-top: 22px; display: none;
        }
        .feedback-area.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
        .feedback-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .feedback-icon { font-size: 28px; }
        .feedback-title { font-size: 18px; font-weight: 800; }
        .feedback-correct { color: #10b981; }
        .feedback-wrong { color: #ef4444; }
        .feedback-warn { color: #f59e0b; }
        .feedback-text { font-size: 13px; color: #475569; line-height: 1.6; margin-bottom: 10px; }
        .feedback-rationale { background: white; border-left: 4px solid #667eea; padding: 14px; border-radius: 8px; margin-top: 12px; }
        .rationale-label { font-size: 11px; font-weight: 700; color: #667eea; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .rationale-text { font-size: 13px; color: #334155; line-height: 1.6; }
        .btn-next {
            width: 100%; padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 15px; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; margin-top: 14px;
        }
        .btn-next:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(102,126,234,0.4); }

        /* ========== ROUND COMPLETE INTERSTITIAL ========== */
        .round-complete {
            text-align: center; display: none; padding: 40px;
            background: white; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .round-complete.show { display: block; animation: fadeInScale 0.4s ease; }
        .round-complete-emoji { font-size: 64px; margin-bottom: 16px; animation: bounce 1s ease infinite; }
        .round-complete-title { font-size: 30px; font-weight: 800; color: #1e293b; margin-bottom: 8px; }
        .round-complete-subtitle { font-size: 15px; color: #64748b; margin-bottom: 28px; }
        .round-complete-stats { display: flex; gap: 16px; justify-content: center; margin-bottom: 28px; }
        .rcs-card { background: #f8fafc; border-radius: 14px; padding: 16px 24px; text-align: center; }
        .rcs-value { font-size: 28px; font-weight: 800; color: #1e293b; }
        .rcs-label { font-size: 12px; color: #64748b; font-weight: 500; margin-top: 4px; }

        /* ========== COMPLETION SCREEN ========== */
        .completion-screen { text-align: center; display: none; }
        .completion-screen.show { display: block; animation: fadeInScale 0.5s ease; }
        @keyframes fadeInScale { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }
        .completion-emoji { font-size: 72px; margin-bottom: 20px; animation: bounce 1s ease infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-16px)} }
        .completion-title { font-size: 34px; font-weight: 800; color: white; margin-bottom: 10px; text-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .completion-subtitle { font-size: 17px; color: rgba(255,255,255,0.9); margin-bottom: 28px; font-weight: 500; }
        .completion-stats { background: white; border-radius: 16px; padding: 28px; margin: 0 0 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .completion-stat { margin-bottom: 20px; }
        .completion-stat:last-child { margin-bottom: 0; }
        .completion-stat-label { font-size: 13px; color: #64748b; font-weight: 500; margin-bottom: 3px; }
        .completion-stat-value { font-size: 30px; font-weight: 800; color: #1e293b; }

        /* ========== MOBILE ========== */
        @media (max-width: 900px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; padding: 20px; }
            .device-card { padding: 28px 20px; }
            .swipe-btn { width: 85px; height: 85px; font-size: 36px; }
            .swipe-label { width: 85px; font-size: 11px; }
            .method-options { grid-template-columns: 1fr; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- ========== SIDEBAR ========== -->
<div class="sidebar">
    <a href="https://emceebe695.github.io/design-control-learning/" class="btn-home">
        ‚Üê Back to Learning Hub
    </a>

    <div class="logo">STERILE GENIUS</div>
    <div class="tagline">3 rounds. 1 expert. Let's go! üíâ</div>

    <div class="difficulty-badge" id="difficultyBadge">Beginner Mode</div>

    <!-- Round Tracker -->
    <div class="round-tracker">
        <div class="round-track-title">Session Progress</div>
        <div class="round-row" id="roundRow1">
            <span class="round-icon">üî¨</span>
            <div class="round-info">
                <div class="round-name">Round 1: Compatible?</div>
                <div class="round-desc">Yes/No compatibility swipe</div>
            </div>
            <span class="round-status status-not-started" id="roundStatus1">‚Äî</span>
        </div>
        <div class="round-row" id="roundRow2">
            <span class="round-icon">üèÜ</span>
            <div class="round-info">
                <div class="round-name">Round 2: Best Choice</div>
                <div class="round-desc">Pick the preferred method</div>
            </div>
            <span class="round-status status-not-started" id="roundStatus2">‚Äî</span>
        </div>
        <div class="round-row" id="roundRow3">
            <span class="round-icon">üß†</span>
            <div class="round-info">
                <div class="round-name">Round 3: Expert Mode</div>
                <div class="round-desc">Strategy & edge cases</div>
            </div>
            <span class="round-status status-not-started" id="roundStatus3">‚Äî</span>
        </div>
    </div>

    <div class="stats-card">
        <div class="stat-row">
            <span class="stat-label">Session</span>
            <span class="stat-value" id="sessionNumber">1</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Round Progress</span>
            <span class="stat-value"><span id="currentItem">0</span>/<span id="totalItems">8</span></span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width:0%"></div>
        </div>
        <div class="stat-row" style="margin-top:10px">
            <span class="stat-label">Score</span>
            <span class="stat-value" id="scoreDisplay" style="color:#667eea">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Errors</span>
            <span class="stat-value" id="errorCount" style="color:#ef4444">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Streak</span>
            <span class="stat-value" id="streakCount" style="color:#10b981">0 üî•</span>
        </div>
    </div>

    <button class="btn-new-session" id="btnNewSession">üîÑ New Session</button>

    <div class="info-section">
        <div class="info-title">Round Guide</div>
        <div class="info-text">
            <strong>Round 1:</strong> Is this device compatible? Swipe ‚úó or ‚úì<br>
            <strong>Round 2:</strong> Which method is <em>preferred</em>? Pick one.<br>
            <strong>Round 3:</strong> Hard scenarios & strategy. Boss level!
        </div>
    </div>

    <div class="info-section">
        <div class="info-title">Scoring</div>
        <div class="info-text">
            ‚úì Correct: +100 pts &nbsp;|&nbsp; ‚úó Wrong: -50 pts<br>
            üí° Hint: -20 pts &nbsp;|&nbsp; üî• 5-streak: +50 bonus<br>
            ‚ö†Ô∏è Compatible-but-not-preferred: -25 pts
        </div>
    </div>

    <div class="info-section">
        <div class="info-title">Keyboard Shortcuts</div>
        <div class="info-text">
            ‚Üê / X = Incompatible &nbsp;|&nbsp; ‚Üí / C = Compatible<br>
            H = Hint
        </div>
    </div>
</div>

<!-- ========== MAIN CONTENT ========== -->
<div class="main-content">
    <div class="game-container">

        <!-- Round Banner -->
        <div class="round-banner" id="roundBanner">
            <span class="round-banner-icon">üî¨</span>
            <div class="round-banner-text">
                <div class="round-banner-title" id="roundBannerTitle">Round 1: Compatible?</div>
                <div class="round-banner-subtitle" id="roundBannerSub">Is this device compatible with the shown method?</div>
            </div>
        </div>

        <!-- Device Card -->
        <div class="device-card" id="deviceCard">
            <div class="difficulty-tag" id="difficultyTag">Foundational</div>
            <h1 class="device-name" id="deviceName">Loading...</h1>
            <p class="device-description" id="deviceDescription"></p>

            <div class="materials-section">
                <div class="materials-row">
                    <span class="materials-label">Primary:</span>
                    <span class="materials-value" id="materialPrimary"></span>
                </div>
                <div class="materials-row" id="materialSecondaryRow">
                    <span class="materials-label">Secondary:</span>
                    <span class="materials-value" id="materialSecondary"></span>
                </div>
            </div>

            <div class="method-section">

                <!-- ROUND 1: SWIPE MODE -->
                <div id="swipeMode">
                    <div class="method-question">Is this device compatible with:</div>
                    <div class="current-method" id="currentMethod">STEAM</div>
                    <div class="swipe-buttons">
                        <button class="swipe-btn btn-incompatible" id="btnIncompatible" aria-label="Incompatible">‚úó</button>
                        <button class="swipe-btn btn-compatible" id="btnCompatible" aria-label="Compatible">‚úì</button>
                    </div>
                    <div class="swipe-labels">
                        <div class="swipe-label label-incompatible">Incompatible</div>
                        <div class="swipe-label label-compatible">Compatible</div>
                    </div>
                </div>

                <!-- ROUND 2 & 3: PICK MODE -->
                <div id="pickMode" class="hidden">
                    <div class="pick-prompt" id="pickPrompt">Which method is preferred for this device?</div>
                    <div class="pick-context" id="pickContext"></div>
                    <div class="method-options" id="methodOptions"></div>
                </div>

                <!-- HINT -->
                <div class="hint-section">
                    <button class="btn-hint" id="btnHint">üí° Show Hint (-20 pts)</button>
                    <div class="hint-display" id="hintDisplay"></div>
                </div>
            </div>

            <!-- Feedback Area -->
            <div class="feedback-area" id="feedbackArea">
                <div class="feedback-header">
                    <span class="feedback-icon" id="feedbackIcon">‚úì</span>
                    <h3 class="feedback-title" id="feedbackTitle">Correct!</h3>
                </div>
                <p class="feedback-text" id="feedbackText"></p>
                <div class="feedback-rationale">
                    <div class="rationale-label">Why This Matters</div>
                    <p class="rationale-text" id="rationaleText"></p>
                </div>
                <button class="btn-next" id="btnNext">Next ‚Üí</button>
            </div>
        </div>

        <!-- Round Complete Interstitial -->
        <div class="round-complete" id="roundComplete">
            <div class="round-complete-emoji" id="rcEmoji">üéâ</div>
            <div class="round-complete-title" id="rcTitle">Round 1 Complete!</div>
            <div class="round-complete-subtitle" id="rcSubtitle">Nice work on compatibility!</div>
            <div class="round-complete-stats">
                <div class="rcs-card">
                    <div class="rcs-value" id="rcAccuracy">0%</div>
                    <div class="rcs-label">Round Accuracy</div>
                </div>
                <div class="rcs-card">
                    <div class="rcs-value" id="rcErrors">0</div>
                    <div class="rcs-label">Errors</div>
                </div>
            </div>
            <button class="btn-new-session" id="btnNextRound" style="max-width:320px;margin:0 auto;display:block;">
                Continue to Next Round ‚Üí
            </button>
        </div>

        <!-- Session Complete -->
        <div class="completion-screen" id="completionScreen">
            <div class="completion-emoji">üèÖ</div>
            <h1 class="completion-title">Session Complete!</h1>
            <p class="completion-subtitle">You're a sterilization expert in the making!</p>
            <div class="completion-stats">
                <div class="completion-stat">
                    <div class="completion-stat-label">Overall Accuracy</div>
                    <div class="completion-stat-value" id="finalAccuracy">0%</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-label">Final Score</div>
                    <div class="completion-stat-value" id="finalScore">0</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-label">Best Streak</div>
                    <div class="completion-stat-value" id="finalStreak">0 üî•</div>
                </div>
            </div>
            <button class="btn-new-session" id="btnNewSessionComplete">Start New Session</button>
        </div>

    </div>
</div>

<script>
// ==========================================
// ANSWER KEY DATA
// ==========================================
const ANSWER_KEY = {
    sterilizationMethods: ["ETO","GAMMA","EBEAM","STEAM","VH2O2"],
    methodDetails: {
        "ETO":   { name:"Ethylene Oxide (EtO)", temp:"40-60¬∞C" },
        "GAMMA": { name:"Gamma Radiation", temp:"Room temp" },
        "EBEAM": { name:"Electron Beam", temp:"Room temp" },
        "STEAM": { name:"Steam Autoclave", temp:"121-134¬∞C" },
        "VH2O2": { name:"Vaporized H‚ÇÇO‚ÇÇ", temp:"45-55¬∞C" },
        "ASEPTIC":{ name:"Aseptic Assembly (No Terminal)", temp:"N/A" }
    },
    items: [
        // ===== FOUNDATIONAL =====
        {
            id:"F001", difficulty:"foundational",
            device_name:"Silicone Foley Catheter",
            material_primary:"Medical-grade silicone", material_secondary:null,
            device_description:"Single-lumen urinary catheter, 16Fr diameter, balloon tip",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"ETO",
            preferred_rationale:"EtO is industry standard for flexible catheters. It penetrates lumen well, has decades of validation history, and avoids radiation-induced surface tackiness in silicone.",
            rationale:"Silicone tolerates both EtO and radiation well. Steam causes swelling (8-12%) and surface tackiness.",
            why_mistake_fails:"Steam at 121¬∞C + moisture causes silicone to swell, become sticky, and lose dimensional stability.",
            hint:"Flexible polymer, long lumen. What method penetrates long skinny things best?"
        },
        {
            id:"F002", difficulty:"foundational",
            device_name:"Stainless Steel Surgical Scissors",
            material_primary:"316L Stainless Steel", material_secondary:null,
            device_description:"Mayo scissors, 6 inch length, sharp-sharp tips, reusable",
            correct_answers:["STEAM","ETO","GAMMA","EBEAM","VH2O2"], best_answer:"STEAM",
            preferred_rationale:"Steam is cheapest (~$0.10-0.50/unit), fastest (30-60 min cycle), available in every hospital SPD, leaves zero residuals, and stainless steel is perfectly heat-stable.",
            rationale:"Stainless steel is heat-stable, corrosion-resistant, and compatible with ALL methods. Steam is optimal economically.",
            why_mistake_fails:"N/A - all methods work!",
            hint:"Hospital reusable metal instrument. Which method costs the least and is everywhere?"
        },
        {
            id:"F003", difficulty:"foundational",
            device_name:"Polypropylene Syringe (Unstabilized)",
            material_primary:"Polypropylene (standard, no stabilizers)", material_secondary:"Rubber plunger",
            device_description:"3mL Luer-lock syringe, graduated markings, disposable",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"EtO is the only viable method for standard (unstabilized) PP. It's industry standard for disposable syringes from BD, Terumo, and others.",
            rationale:"Standard PP is radiation-sensitive (chain scission ‚Üí embrittlement). Steam causes warping at 121¬∞C. EtO is the only option.",
            why_mistake_fails:"Unstabilized PP exposed to 25 kGy gamma undergoes chain scission, reducing MW by 30-40%. Barrel becomes brittle and cracks.",
            hint:"Standard PP is radiation-sensitive. Heat deforms it. Only one method works."
        },
        {
            id:"F004", difficulty:"foundational",
            device_name:"Latex Surgical Gloves",
            material_primary:"Natural rubber latex", material_secondary:"Cornstarch powder coating",
            device_description:"Size 7.5, sterile, powder-free option available",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"Gamma is preferred: latex tolerates it well, no aeration needed (saves 2-7 days vs EtO), no residuals, and faster throughput. Most sterile glove manufacturers use gamma.",
            rationale:"Natural rubber tolerates radiation well. Steam causes protein degradation and yellowing of latex.",
            why_mistake_fails:"Autoclave heat (121¬∞C) degrades natural rubber proteins, causing yellowing and loss of elasticity.",
            hint:"Natural rubber + high volume disposable. Which method is faster and leaves no residuals?"
        },
        {
            id:"F005", difficulty:"foundational",
            device_name:"Cotton Surgical Gauze",
            material_primary:"100% cotton fibers (cellulose)", material_secondary:null,
            device_description:"4x4 inch pads, non-woven, sterile",
            correct_answers:["STEAM","ETO","GAMMA","EBEAM"], best_answer:"STEAM",
            preferred_rationale:"Cotton (cellulose) is perfectly heat and moisture-stable. Steam is cheapest and fastest for bulk hospital gauze. VH2O2 is incompatible with cellulose.",
            rationale:"Cotton tolerates steam perfectly. Steam is cheapest for high-volume cellulose items. VH2O2 cannot be used with cellulose.",
            why_mistake_fails:"VH2O2 is absorbed by cellulose like a sponge - concentration never reaches target. Sterilizer aborts cycle.",
            hint:"100% cellulose. Cheapest, fastest, and hospitals have it everywhere."
        },
        {
            id:"F006", difficulty:"foundational",
            device_name:"PVC IV Tubing Set",
            material_primary:"PVC with DEHP plasticizer", material_secondary:"Polycarbonate Luer connectors",
            device_description:"Standard IV administration set, 72 inch length, roller clamp",
            correct_answers:["ETO","GAMMA"], best_answer:"ETO",
            preferred_rationale:"EtO is industry standard for IV sets. PVC with DEHP can yellow under high-dose gamma. PC connectors are radiation-sensitive. EtO preserves clarity and dimensional stability.",
            rationale:"PVC+DEHP is radiation-sensitive (yellowing, embrittlement) at higher doses. PC is also radiation-sensitive. EtO is safest for the full assembly.",
            why_mistake_fails:"PVC softens at ~80¬∞C; autoclave at 121¬∞C causes deformation, plasticizer migration, and tubing kinking.",
            hint:"Two radiation-sensitive plastics (PVC with DEHP + PC connectors). What's left?"
        },
        {
            id:"F007", difficulty:"foundational",
            device_name:"Glass Syringe (Reusable)",
            material_primary:"Borosilicate glass barrel", material_secondary:"Stainless steel plunger",
            device_description:"10mL, laboratory-grade, autoclavable",
            correct_answers:["STEAM","GAMMA","EBEAM"], best_answer:"STEAM",
            preferred_rationale:"Borosilicate glass + stainless steel = perfectly heat-stable. Steam is standard for all lab glassware. Fast, cheap, zero residuals.",
            rationale:"Both materials are heat-stable. Steam is standard for reusable glass lab equipment.",
            why_mistake_fails:"N/A - glass and metal are highly compatible with multiple methods.",
            hint:"Lab glassware + metal. What does every lab use in the autoclave?"
        },
        {
            id:"F008", difficulty:"foundational",
            device_name:"HDPE Specimen Container",
            material_primary:"High-density polyethylene (HDPE)", material_secondary:null,
            device_description:"60mL screw-cap container, single-use disposable",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"HDPE has excellent radiation stability. Gamma is cost-effective at high volumes ($0.35/unit vs $0.75 EtO), no aeration hold needed, and immediate product release.",
            rationale:"HDPE is radiation-stable. Gamma is economically superior for high-volume disposables. Steam softens HDPE.",
            why_mistake_fails:"HDPE softens at ~120-130¬∞C; autoclave is right at that edge and causes warping + cap seal failure.",
            hint:"HDPE is radiation-stable. High-volume disposable. Which method is cheapest per unit?"
        },
        {
            id:"F009", difficulty:"foundational",
            device_name:"Nylon Suture (Monofilament)",
            material_primary:"Nylon 6 (polyamide)", material_secondary:null,
            device_description:"3-0 monofilament, 18 inch, non-absorbable, blue",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Nylon (polyamide) loses 30-50% tensile strength under gamma radiation (chain scission). EtO is the only method that preserves suture strength. Industry standard for all nylon sutures.",
            rationale:"Nylon is highly radiation-sensitive. Steam causes hydrolysis. EtO is the only compatible method.",
            why_mistake_fails:"Gamma causes nylon chain scission, reducing tensile strength 30-50%. Suture snaps during tissue closure.",
            hint:"Nylon (polyamide) = worst radiation stability of common suture materials."
        },
        {
            id:"F010", difficulty:"foundational",
            device_name:"Titanium Hip Implant",
            material_primary:"Ti-6Al-4V titanium alloy", material_secondary:null,
            device_description:"Total hip replacement femoral stem, cementless, porous coated",
            correct_answers:["STEAM","ETO","GAMMA","EBEAM","VH2O2"], best_answer:"STEAM",
            preferred_rationale:"Titanium is heat-stable, corrosion-resistant, and radiation-stable. All methods work. Steam is fastest and cheapest for terminal sterilization of bare metal implants.",
            rationale:"Titanium is compatible with ALL sterilization methods. Steam is economically optimal.",
            why_mistake_fails:"N/A - titanium survives any sterilization method!",
            hint:"Titanium = nearly indestructible. Any method works. Which is fastest/cheapest?"
        },
        {
            id:"F011", difficulty:"foundational",
            device_name:"Paper Surgical Drape (PE-Coated)",
            material_primary:"Cellulose paper + polyethylene coating", material_secondary:null,
            device_description:"Disposable surgical drape, 36x48 inches, fluid-resistant",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"ETO",
            preferred_rationale:"VH2O2 incompatible with cellulose. Steam damages PE coating. EtO penetrates paper well and maintains coating integrity. Standard for disposable drapes.",
            rationale:"Paper with PE coating: VH2O2 absorbed by cellulose, steam damages coating. EtO or radiation only.",
            why_mistake_fails:"Cellulose absorbs H2O2 vapor - cycle fails. Steam melts/damages PE coating integrity.",
            hint:"Cellulose = no VH2O2. PE coating = no steam. What's left?"
        },
        {
            id:"F012", difficulty:"foundational",
            device_name:"Polycarbonate Face Shield",
            material_primary:"Polycarbonate", material_secondary:"Foam padding",
            device_description:"Protective face shield, surgical/clinical use, optically clear",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"PC is radiation-sensitive (yellows, loses 20-30% impact strength). EtO maintains optical clarity - critical for protective equipment. Industry standard for PC-based devices.",
            rationale:"Polycarbonate yellows and becomes brittle under gamma. EtO maintains optical clarity and impact strength.",
            why_mistake_fails:"Gamma causes PC to turn amber/yellow and lose impact resistance. Shield becomes dangerous in a drop.",
            hint:"PC is radiation-sensitive. Transparency matters. What preserves optical clarity?"
        },
        {
            id:"F013", difficulty:"foundational",
            device_name:"Polyester (PET) Suture",
            material_primary:"PET (Dacron)", material_secondary:"Silicone coating",
            device_description:"Braided suture, 2-0, coated, non-absorbable, green",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"PET has excellent radiation stability. Gamma is standard for synthetic braided sutures: no residuals, no aeration wait, fast throughput. Silicone coating tolerates radiation well.",
            rationale:"PET (Dacron) is radiation-stable. Gamma is standard for synthetic sutures.",
            why_mistake_fails:"Steam degrades silicone coating and causes braided structure to absorb moisture, changing handling feel.",
            hint:"PET = excellent radiation stability. High-volume synthetic suture. Which method has no residuals?"
        },
        {
            id:"F014", difficulty:"foundational",
            device_name:"Stainless Steel Hemostats",
            material_primary:"420 stainless steel", material_secondary:null,
            device_description:"Kelly clamps, 5.5 inch curved, ratcheted, reusable",
            correct_answers:["STEAM","VH2O2"], best_answer:"STEAM",
            preferred_rationale:"Reusable surgical clamps are steam-sterilized between every case in hospital SPD. Fast (30 min), cheap, available on-site, and steel is perfectly compatible.",
            rationale:"Standard reusable surgical clamps. Steam is the universal hospital standard for reusable metal instruments.",
            why_mistake_fails:"N/A - metal clamps are perfect for steam!",
            hint:"Hospital reusable instrument. Steam SPD is the standard."
        },
        {
            id:"F015", difficulty:"foundational",
            device_name:"Rigid Endoscope (Stainless + Glass)",
            material_primary:"Stainless steel shaft + glass rod lenses", material_secondary:null,
            device_description:"Laparoscopic telescope, 10mm diameter, 0-degree, reusable",
            correct_answers:["STEAM","VH2O2"], best_answer:"STEAM",
            preferred_rationale:"Metal + glass is heat-stable. Steam is standard for rigid reusable endoscopes. VH2O2 is used when heat sensitivity is a concern, but rigid scopes tolerate steam well.",
            rationale:"Metal and glass tolerate steam. VH2O2 also an option for hospital reprocessing. Both are common.",
            why_mistake_fails:"N/A - metal and glass endoscopes are steam-compatible.",
            hint:"Reusable hospital instrument. Metal + glass = heat-stable."
        },
        {
            id:"F016", difficulty:"foundational",
            device_name:"HDPE Specimen Container (High Volume)",
            material_primary:"High-density polyethylene", material_secondary:null,
            device_description:"10mL urine collection cup, 10 million units/year production",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"At 10M units/year, cost matters enormously. Gamma: ~$0.35/unit. EtO: ~$0.75/unit. HDPE tolerates both equally. Gamma saves ~$4M annually. No aeration wait = faster supply chain.",
            rationale:"HDPE is compatible with EtO, gamma, and e-beam. At high volume, gamma's lower cost and faster cycle time make it clearly optimal.",
            why_mistake_fails:"Steam softens HDPE near its melting point; container warps and cap fails.",
            hint:"10 million units. Cost is the deciding factor here. What's cheapest per unit?"
        },
        {
            id:"F017", difficulty:"foundational",
            device_name:"Aluminum External Fixator",
            material_primary:"Aluminum alloy 7075-T6", material_secondary:"Stainless steel connecting rods",
            device_description:"External bone fixation frame for fracture stabilization",
            correct_answers:["STEAM","ETO","GAMMA","EBEAM"], best_answer:"STEAM",
            preferred_rationale:"Both aluminum and stainless steel are heat-stable. Steam is economically optimal for metal orthopedic devices. No residuals, fast cycle.",
            rationale:"Both metals are heat-stable and radiation-stable. Steam is optimal for all-metal devices.",
            why_mistake_fails:"N/A - metals are stable!",
            hint:"Two metals. Heat-stable. Cheapest method?"
        },
        {
            id:"F018", difficulty:"foundational",
            device_name:"Braided Silk Suture",
            material_primary:"Natural silk protein fibers", material_secondary:"Wax coating",
            device_description:"Braided silk, 3-0, non-absorbable, black",
            correct_answers:["ETO","GAMMA"], best_answer:"ETO",
            preferred_rationale:"EtO is the traditional industry standard for silk sutures. Gamma works but high doses can reduce tensile strength of natural protein fibers. EtO validated for most silk suture lines.",
            rationale:"Silk protein tolerates both EtO and controlled gamma. Heat (steam) denatures protein structure.",
            why_mistake_fails:"Steam causes protein denaturation and loss of tensile strength. Silk loses 40-60% strength under autoclave.",
            hint:"Natural protein fiber. Heat = denaturation. Traditional method for silk?"
        },

        // ===== INTERMEDIATE =====
        {
            id:"I001", difficulty:"intermediate",
            device_name:"PEEK Spinal Cage Implant",
            material_primary:"Polyetheretherketone (PEEK)", material_secondary:"Titanium endplates",
            device_description:"Interbody fusion cage, porous structure for bone ingrowth",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"PEEK is radiation-sensitive despite being a 'high-performance' polymer. Gamma causes discoloration (white‚Üíbrown/black) and 10-15% compressive strength reduction. EtO is the ONLY acceptable method for PEEK implants.",
            rationale:"PEEK yellows/darkens under gamma and loses compressive strength. EtO is industry standard for all PEEK implants.",
            why_mistake_fails:"Gamma causes PEEK to turn brown/black - aesthetically and mechanically unacceptable for spinal implants.",
            hint:"PEEK seems tough but it's radiation-sensitive. One method works."
        },
        {
            id:"I002", difficulty:"intermediate",
            device_name:"Silicone Breast Implant (Long-Term)",
            material_primary:"Medical-grade silicone shell", material_secondary:"Cohesive silicone gel",
            device_description:"Textured surface implant, 400cc, 10-20 year expected lifespan",
            correct_answers:["ETO","GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"For 10-20 year implants, radiation is preferred to eliminate EtO residual concerns. Even after extended aeration, trace EtO can remain in silicone matrix. Zero residuals with gamma = safer for long-term implants.",
            rationale:"Both EtO and radiation work for silicone. For long-term implants, gamma is preferred due to zero residual concerns.",
            why_mistake_fails:"Steam causes silicone surface changes, shell swelling, and potential gel consistency alteration.",
            hint:"Long-term implant (10-20 years). EtO leaves residuals. Which method has zero residuals?"
        },
        {
            id:"I003", difficulty:"intermediate",
            device_name:"Acetal (POM) Instrument Handle",
            material_primary:"Polyoxymethylene (Acetal/Delrin)", material_secondary:"Stainless steel insert",
            device_description:"Ergonomic handle for laparoscopic grasper, reusable",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Acetal (POM) has THE WORST radiation stability of common engineering plastics - catastrophic embrittlement at doses as low as 15 kGy. EtO is the ONLY viable method.",
            rationale:"Acetal undergoes severe chain scission under radiation. EtO is the only viable method for Acetal/Delrin components.",
            why_mistake_fails:"Even 15 kGy causes Acetal handle to crumble. Steam heat also problematic (Acetal melts at ~165¬∞C but dimensional stability lost earlier).",
            hint:"Acetal/POM = worst radiation stability of all common plastics. Only one safe method."
        },
        {
            id:"I004", difficulty:"intermediate",
            device_name:"PP Hernia Mesh (Radiation-Stabilized)",
            material_primary:"PP with antioxidant stabilizers", material_secondary:null,
            device_description:"Surgical mesh, knitted, 6x11cm, for hernia repair",
            correct_answers:["GAMMA","EBEAM","ETO"], best_answer:"GAMMA",
            preferred_rationale:"Modern hernia mesh uses radiation-stabilized PP specifically formulated for 25-35 kGy gamma. Gamma is preferred: no residuals, faster than EtO (no 2-7 day aeration), consistent dosing. Note: unstabilized PP would FAIL gamma!",
            rationale:"Radiation-stabilized PP is specifically formulated for gamma sterilization. Material costs 15-20% more but maintains all mechanical properties.",
            why_mistake_fails:"Unstabilized PP would fail, but STABILIZED grades are designed for gamma.",
            hint:"Key word: 'radiation-stabilized.' This changes everything vs standard PP."
        },
        {
            id:"I005", difficulty:"intermediate",
            device_name:"Copper IUD",
            material_primary:"Copper wire + polypropylene frame", material_secondary:null,
            device_description:"T-shaped contraceptive device, 10-year implant",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"Copper oxidizes under steam (moisture + heat ‚Üí green Cu2O patina, altering copper ion release kinetics). PP frame may also be heat-sensitive. Gamma sterilizes in sealed packaging with no moisture exposure.",
            rationale:"Copper oxidizes with steam moisture+heat. Radiation avoids moisture entirely. Gamma is standard for copper IUDs.",
            why_mistake_fails:"Steam causes copper oxidation (green patina), changing copper ion release kinetics - the primary contraceptive mechanism.",
            hint:"Copper + moisture + heat = oxidation. What method avoids moisture entirely?"
        },
        {
            id:"I006", difficulty:"intermediate",
            device_name:"Hydrogel Wound Dressing",
            material_primary:"PEG hydrogel (85% water content)", material_secondary:"Polyester backing",
            device_description:"Moisture-retentive wound dressing, 4x4 inch, for burns",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"85% water content blocks EtO gas penetration entirely (EtO doesn't diffuse through aqueous media). Gamma penetrates through the water matrix and sterilizes in final packaging. Steam destroys hydrogel crosslink structure.",
            rationale:"High water content prevents EtO penetration. Gamma is the only terminal sterilization option for hydrogel products.",
            why_mistake_fails:"85% water = EtO cannot penetrate. Steam destroys hydrogel 3D structure entirely.",
            hint:"85% water content. EtO + water = impenetrable barrier. What goes through everything?"
        },
        {
            id:"I007", difficulty:"intermediate",
            device_name:"PTFE Vascular Graft",
            material_primary:"Expanded PTFE (ePTFE)", material_secondary:null,
            device_description:"Synthetic blood vessel graft, 6mm diameter x 40cm length",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Despite PTFE being chemically inert, it is radiation-sensitive (chain scission reduces tensile strength 30-40%). Graft rupture under blood pressure = catastrophic. EtO is the ONLY acceptable method for ePTFE vascular grafts.",
            rationale:"PTFE (Teflon) is radiation-sensitive despite chemical inertness. Chain scission = 30-40% strength loss. EtO only.",
            why_mistake_fails:"PTFE chain scission under radiation: tensile strength drops 30-40%. Vascular graft ruptures under arterial blood pressure.",
            hint:"PTFE = chemically inert but radiation-sensitive. This surprises most people. One method works."
        },
        {
            id:"I008", difficulty:"intermediate",
            device_name:"Nitinol Stent (Drug-Coated)",
            material_primary:"Nitinol mesh", material_secondary:"PDLLA coating + paclitaxel drug",
            device_description:"Drug-eluting peripheral stent, 6mm x 40mm, 12-month drug release",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Nitinol is radiation-stable, BUT the PDLLA polymer coating and paclitaxel drug dictate the method. Radiation crosslinks PDLLA, altering drug release kinetics. The coating is the limiting factor.",
            rationale:"Metal is stable but coating controls sterilization choice. Gamma alters drug release kinetics = clinical failure.",
            why_mistake_fails:"Radiation crosslinks PDLLA polymer. Drug release profile shifts: potentially toxic burst or ineffective slow release.",
            hint:"Metal is fine with any method. What material is the LIMITING factor here?"
        },
        {
            id:"I009", difficulty:"intermediate",
            device_name:"Glucose Test Strips (Enzyme-Based)",
            material_primary:"Polyester substrate + printed circuits", material_secondary:"Glucose oxidase enzyme",
            device_description:"Blood glucose test strips, enzyme-based electrochemical detection",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"If terminal sterilization is required, low-dose gamma (10-15 kGy) minimally impacts enzyme activity (85-95% retained). Most manufacturers use aseptic assembly to avoid this entirely.",
            rationale:"Enzyme activity requires careful method selection. Low-dose gamma preserves glucose oxidase function better than EtO.",
            why_mistake_fails:"Heat (>60¬∞C) denatures glucose oxidase enzyme protein. No enzyme activity = no glucose reading = dangerous.",
            hint:"Enzyme = protein. Heat = denaturation. Low-dose radiation preserves protein activity."
        },
        {
            id:"I010", difficulty:"intermediate",
            device_name:"Polycarbonate Oxygenator Housing",
            material_primary:"Polycarbonate", material_secondary:"Silicone membrane",
            device_description:"Heart-lung machine oxygenator, single-use, blood flow visible",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"PC housing transparency is critical for visual monitoring of blood flow and air bubble detection (patient safety). Gamma yellows PC. EtO maintains full optical clarity. Non-negotiable for patient safety.",
            rationale:"PC is radiation-sensitive. Transparency for blood flow visualization is critical for patient safety. EtO only.",
            why_mistake_fails:"Gamma yellows PC housing - cannot visually verify blood flow or detect air emboli. Safety violation.",
            hint:"PC housing where visibility is a patient safety issue. Yellowing = dangerous."
        },
        {
            id:"I011", difficulty:"intermediate",
            device_name:"UHMWPE Acetabular Liner",
            material_primary:"Ultra-high molecular weight polyethylene", material_secondary:null,
            device_description:"Acetabular liner for total hip replacement, bearing surface",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"UHMWPE in orthopedics is INTENTIONALLY gamma-sterilized because radiation simultaneously sterilizes AND crosslinks the polymer, improving wear resistance by 50-80%. Radiation serves a dual purpose here - unique to UHMWPE.",
            rationale:"Gamma both sterilizes and crosslinks UHMWPE (25-100 kGy), dramatically improving wear resistance. Dual-purpose use.",
            why_mistake_fails:"Steam softens UHMWPE (melting point ~130¬∞C, very close to 121¬∞C autoclave). EtO works but misses the crosslinking benefit.",
            hint:"UHMWPE is special: radiation IMPROVES the material by crosslinking it. What's the dual-purpose method?"
        },
        {
            id:"I012", difficulty:"intermediate",
            device_name:"ABS Plastic Surgical Tray",
            material_primary:"Acrylonitrile butadiene styrene (ABS)", material_secondary:null,
            device_description:"Rigid tray for instrument organization, sterile field",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"ABS contains butadiene, which is highly radiation-sensitive. Gamma causes dramatic yellowing (white‚Üíyellow‚Üíbrown) and embrittlement. EtO maintains color and impact strength.",
            rationale:"ABS is radiation-sensitive (butadiene component). EtO maintains aesthetics and mechanical properties.",
            why_mistake_fails:"ABS yellows dramatically under gamma due to butadiene oxidation. Tray becomes brittle and cracks when dropped.",
            hint:"ABS contains butadiene - the radiation-sensitive component. Think gas sterilization."
        },
        {
            id:"I013", difficulty:"intermediate",
            device_name:"PLA Absorbable Suture",
            material_primary:"Poly-lactic acid (PLA)", material_secondary:null,
            device_description:"Absorbable suture, 3-0, monofilament, 90-day absorption",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"PLA is radiation-sensitive (chain scission accelerates degradation). With EtO, controlled 90-day absorption is maintained. Radiation could reduce this to weeks or days - clinically unacceptable.",
            rationale:"PLA undergoes chain scission under radiation, accelerating degradation rate unpredictably. EtO preserves designed absorption timeline.",
            why_mistake_fails:"Gamma causes PLA chain scission. Suture may lose strength and absorb within days instead of 90 days.",
            hint:"Absorbable polymer. Radiation accelerates degradation. Only one method keeps the timeline intact."
        },
        {
            id:"I014", difficulty:"intermediate",
            device_name:"Collagen Hemostatic Sponge",
            material_primary:"Bovine collagen matrix", material_secondary:null,
            device_description:"Hemostatic agent for surgical bleeding control",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"Collagen tolerates controlled gamma doses (15-25 kGy) while maintaining hemostatic function. Heat above 65¬∞C denatures collagen triple helix structure. Gamma is FDA-accepted for collagen products.",
            rationale:"Collagen tolerates controlled radiation. Heat denatures the collagen triple helix, destroying hemostatic function.",
            why_mistake_fails:"Steam (>65¬∞C) denatures collagen triple helix. Collagen becomes gelatin - no structural integrity for hemostasis.",
            hint:"Collagen = protein. Heat = triple helix denaturation (makes it gelatin). Controlled radiation works."
        },
        {
            id:"I015", difficulty:"intermediate",
            device_name:"Flexible Cystoscope (Reusable)",
            material_primary:"Fiber optic bundle + polymer sheath", material_secondary:"Stainless steel channels",
            device_description:"Flexible endoscope for bladder visualization, reusable, hospital-based",
            correct_answers:["VH2O2"], best_answer:"VH2O2",
            preferred_rationale:"Flexible endoscopes cannot tolerate steam (polymer sheath + optics). EtO works but facilities are closing. VH2O2 is now the standard for flexible endoscope reprocessing in hospitals - fast (45-75 min), low temp, no toxic residuals.",
            rationale:"Flexible endoscopes: too delicate for steam, polymer incompatible with heat. VH2O2 is the hospital reprocessing standard for flexible scopes.",
            why_mistake_fails:"Steam heat destroys fiber optic bundles and warps polymer sheath. Single-use would be the other solution.",
            hint:"Flexible endoscope reprocessing in hospitals. Low-temp method that replaced EtO concerns?"
        },
        {
            id:"I016", difficulty:"intermediate",
            device_name:"PP Syringe (Radiation-Stabilized Grade)",
            material_primary:"PP with antioxidant radiation stabilizers", material_secondary:"Rubber plunger",
            device_description:"3mL Luer-lock, formulated for radiation sterilization",
            correct_answers:["GAMMA","EBEAM","ETO"], best_answer:"GAMMA",
            preferred_rationale:"Radiation-stabilized PP enables gamma sterilization at 25-30 kGy with no embrittlement. Gamma preferred: no aeration, faster release, lower cost vs EtO. Material costs 15-20% more but enables this.",
            rationale:"Stabilized PP formulations tolerate 25-30 kGy gamma. Gamma is preferred for cost and speed.",
            why_mistake_fails:"N/A - demonstrates that material formulation determines sterilization compatibility!",
            hint:"STABILIZED PP. Same polymer as F003 but different formulation. What does stabilization enable?"
        },
        {
            id:"I017", difficulty:"intermediate",
            device_name:"Decellularized Porcine Heart Valve",
            material_primary:"Acellular porcine tissue matrix", material_secondary:null,
            device_description:"Biological valve for aortic valve replacement, decellularized",
            correct_answers:["GAMMA"], best_answer:"GAMMA",
            preferred_rationale:"Decellularized tissue requires terminal sterilization. Low-dose gamma (10-18 kGy) achieves SAL while minimizing collagen/elastin damage. FDA-accepted for tissue products. EtO absorbed excessively by tissue (3-6 weeks aeration). Steam shrinks tissue.",
            rationale:"Gamma at controlled low dose is FDA-accepted for biological tissue products. Tissue absorbs EtO excessively.",
            why_mistake_fails:"EtO: 3-6 weeks aeration required (tissue acts as sponge). Steam: tissue shrinks like cooked meat.",
            hint:"Biological tissue. EtO absorption = weeks of aeration. Low-dose gamma is FDA-accepted."
        },
        {
            id:"I018", difficulty:"intermediate",
            device_name:"Stainless Steel + PEEK Composite Instrument",
            material_primary:"Stainless steel base", material_secondary:"PEEK insulating components",
            device_description:"Surgical instrument with PEEK insulators, reusable",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Steel tolerates everything. BUT PEEK is radiation-sensitive (discoloration). PEEK is the LIMITING MATERIAL that dictates EtO. Critical concept: always identify the most restrictive material.",
            rationale:"Multi-material device: steel is universal BUT PEEK limits the choice. PEEK determines the sterilization method.",
            why_mistake_fails:"PEEK discolors brown/black under gamma. Affects precision instrument aesthetics and may signal material degradation.",
            hint:"Multi-material device. Which material is the LIMITING factor? PEEK dictates the method."
        },

        // ===== ADVANCED =====
        {
            id:"A001", difficulty:"advanced",
            device_name:"Drug-Eluting Coronary Stent",
            material_primary:"Cobalt-chromium alloy", material_secondary:"Biodegradable polymer + sirolimus drug",
            device_description:"Coronary stent, controlled drug release over 3-6 months",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Drug + biodegradable polymer are radiation-sensitive combination products. Gamma crosslinks polymer coating, altering drug release kinetics. Sirolimus stability may also be affected. EtO is the only validated method for all DES.",
            rationale:"Drug and polymer are radiation-sensitive. Altered drug release = either toxic or ineffective. EtO preserves drug stability and polymer coating integrity.",
            why_mistake_fails:"Radiation crosslinks polymer. Drug may release in hours instead of months (toxicity) or be trapped indefinitely (ineffective).",
            hint:"Combination product: drug + polymer + metal. Drug stability is the critical constraint."
        },
        {
            id:"A002", difficulty:"advanced",
            device_name:"3D-Printed PLLA Surgical Guide",
            material_primary:"Poly-L-lactic acid (PLLA)", material_secondary:null,
            device_description:"Custom drill guide for dental implant, SLA-printed, patient-specific",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"PLLA is among the most radiation-sensitive biodegradable polymers. Even 15-20 kGy causes 50-70% mechanical property loss AND accelerates resorption timeline. Steam causes distortion (Tg ~60¬∞C). EtO with extended aeration is the ONLY option.",
            rationale:"PLLA loses 50-70% properties under radiation. Steam distorts it (Tg ~60¬∞C). EtO is the only method preserving dimensional accuracy.",
            why_mistake_fails:"PLLA radiation exposure: guide becomes brittle, loses dimensional accuracy (2-3mm deviation). Implant placed wrong = surgical disaster.",
            hint:"PLLA = highly radiation-sensitive biodegradable polymer + low Tg. What's the only option?"
        },
        {
            id:"A003", difficulty:"advanced",
            device_name:"Pacemaker with Lithium Battery",
            material_primary:"Titanium housing", material_secondary:"Lithium-ion battery + electronics",
            device_description:"Implantable cardiac pacemaker, 8-10 year battery life",
            correct_answers:["VH2O2"], best_answer:"VH2O2",
            preferred_rationale:"CRITICAL SAFETY: Lithium batteries create spark risk with EtO (flammable at 3-12% concentration = EXPLOSION HAZARD). Steam heat damages electronics and battery. VH2O2 is the only safe low-temp, non-flammable, non-ionizing method. Most pacemakers use aseptic assembly.",
            rationale:"Lithium battery + EtO = explosion risk. Steam damages electronics. VH2O2 or aseptic assembly required.",
            why_mistake_fails:"Battery + EtO gas = FIRE/EXPLOSION HAZARD. Lithium can spark; EtO is explosive at 3-12% concentration.",
            hint:"Battery spark + flammable gas = ? VH2O2 is low-temp AND non-flammable."
        },
        {
            id:"A004", difficulty:"advanced",
            device_name:"Bioresorbable Vascular Scaffold",
            material_primary:"Poly-L-lactic acid (PLLA) stent structure", material_secondary:"PDLLA coating",
            device_description:"Coronary scaffold designed to dissolve over 2-3 years",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Both PLLA and PDLLA are extremely radiation-sensitive. Even 15-20 kGy causes molecular weight drop (30-50%), loss of radial strength, and premature resorption (weeks instead of years). EtO with extended aeration (14-21 days) is the only validated method.",
            rationale:"PLLA/PDLLA are extremely radiation-sensitive. Even low-dose radiation causes scaffold to lose radial strength and resorb prematurely.",
            why_mistake_fails:"Scaffold collapses within weeks instead of years post-radiation exposure. Patient restenosis risk.",
            hint:"Two radiation-sensitive bioresorbable polymers. Scaffold must maintain radial strength for 2-3 years."
        },
        {
            id:"A005", difficulty:"advanced",
            device_name:"CGM Subcutaneous Sensor",
            material_primary:"Platinum electrode", material_secondary:"Glucose oxidase enzyme + PTFE housing",
            device_description:"Continuous glucose monitor, 7-14 day subcutaneous wear",
            correct_answers:["GAMMA"], best_answer:"GAMMA",
            preferred_rationale:"Enzyme must retain activity. Low-dose gamma (12-18 kGy) preserves 85-95% glucose oxidase activity. EtO residuals are a cytotoxicity concern for 7-14 day subcutaneous implant. PTFE is radiation-sensitive BUT at low dose (12-18 kGy) damage is acceptable. Zero residuals = gamma wins.",
            rationale:"Enzyme sensor for subcutaneous use: EtO residuals are cytotoxicity concern for 7-14 day implant. Low-dose gamma preserves enzyme activity.",
            why_mistake_fails:"EtO residuals in small subcutaneous device create cytotoxicity risk. PTFE strength adequate at low gamma doses.",
            hint:"7-14 day subcutaneous implant. EtO residuals = cytotoxicity concern. Low-dose radiation preserves enzyme."
        },
        {
            id:"A006", difficulty:"advanced",
            device_name:"Legacy Device: EtO Facility Closure Crisis",
            material_primary:"PC hub + PVC tubing + silicone tip", material_secondary:null,
            device_description:"Established catheter; only EtO-validated. Sole contract sterilizer closes due to EPA restrictions (2024).",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"REGULATORY SCENARIO: PVC and silicone tolerate gamma. BUT polycarbonate yellows under radiation. Can't switch without design change + new validation + FDA submission (6-12 months). Options: (1) Find alternate EtO facility, (2) Reformulate PC‚ÜíPPSU, (3) Design change + revalidation. None are quick.",
            rationale:"Multi-material with PC as limiting material. Design change to enable radiation requires FDA supplement filing + full revalidation. Not a quick fix.",
            why_mistake_fails:"Gamma yellows PC hub. FDA sees this as a design change - requires new submission. Business continuity crisis.",
            hint:"PC is radiation-sensitive. Switching sterilization methods requires what regulatory action?"
        },
        {
            id:"A007", difficulty:"advanced",
            device_name:"PCL/Collagen Electrospun Scaffold",
            material_primary:"PCL nanofibers", material_secondary:"Type I collagen co-electrospun",
            device_description:"3D electrospun porous scaffold for tissue engineering, 10x10x5mm",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"PCL nanofibers tolerate low-dose radiation (18-25 kGy max before embrittlement). Collagen tolerates controlled doses. Steam melts PCL entirely (Tm ~60¬∞C) - nanofiber morphology completely destroyed. Low-dose gamma is the only terminal sterilization option.",
            rationale:"PCL melts at ~60¬∞C; autoclave at 121¬∞C completely destroys nanofiber architecture. Low-dose gamma preserves structure.",
            why_mistake_fails:"PCL melts at 60¬∞C. Autoclave = complete loss of porous scaffold structure. Collagen also denatures.",
            hint:"PCL melts at 60¬∞C. Autoclave = 121¬∞C. What happens to the nanofibers?"
        },
        {
            id:"A008", difficulty:"advanced",
            device_name:"Electrosurgical Pencil (Multi-Material Boss)",
            material_primary:"Polycarbonate handle", material_secondary:"SS electrode + electronic circuit + silicone button",
            device_description:"Disposable electrosurgical cautery pencil with activation button",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"BOSS LEVEL: PC is radiation-sensitive (yellows). Circuit cannot tolerate moisture (steam). Battery/electronics = no high heat. Silicone = flexible (fine). Steel = fine. EtO is the ONLY method compatible with ALL components simultaneously.",
            rationale:"Multi-material: PC (no gamma), electronics (no moisture/heat), silicone (EtO ok), steel (EtO ok). EtO is the only universal answer.",
            why_mistake_fails:"Gamma: PC yellows. Steam: electronics/circuit moisture damage. Every other method fails at least one component.",
            hint:"Map each material to what it can't tolerate. Only one method survives the full matrix."
        },
        {
            id:"A009", difficulty:"advanced",
            device_name:"UHMWPE Joint Liner - Dose Optimization",
            material_primary:"UHMWPE (crosslinked, high-dose)", material_secondary:null,
            device_description:"Acetabular liner; surgeon requests HIGHEST radiation dose for maximum crosslinking",
            correct_answers:["GAMMA","EBEAM"], best_answer:"GAMMA",
            preferred_rationale:"NUANCED SCENARIO: Higher dose = better crosslinking (wear resistance) but also increases oxidative degradation risk unless packaged in inert atmosphere. Standard 25 kGy for sterility; 50-100 kGy for highly crosslinked UHMWPE. Must also re-melt or anneal post-irradiation to quench free radicals. Gamma + inert packaging is standard.",
            rationale:"UHMWPE is intentionally irradiated for crosslinking. Dose optimization balances wear improvement vs oxidative degradation. Inert packaging essential.",
            why_mistake_fails:"Without inert atmosphere packaging, high-dose gamma creates free radicals ‚Üí long-term oxidative embrittlement (implant fails at 5-10 years).",
            hint:"UHMWPE radiation = sterilization + crosslinking. But high dose + oxygen = long-term problem. What else is needed?"
        },
        {
            id:"A010", difficulty:"advanced",
            device_name:"Alginate-Chitosan Drug Delivery Microspheres",
            material_primary:"Calcium alginate + chitosan shell", material_secondary:"Encapsulated protein drug",
            device_description:"Injectable drug delivery microspheres, 50-200 micron diameter",
            correct_answers:[], best_answer:"ASEPTIC",
            preferred_rationale:"IMPOSSIBLE TO TERMINALLY STERILIZE: Protein drug denatures at any temperature. Radiation denatures protein AND causes alginate/chitosan chain scission changing release kinetics. No terminal method works. ONLY aseptic assembly in ISO 5 environment is viable. This teaches that some designs MUST use aseptic manufacturing.",
            rationale:"Protein drug cannot survive any terminal method. This is a key lesson: some products cannot be terminally sterilized and require aseptic manufacturing.",
            why_mistake_fails:"All methods fail: steam denatures protein, radiation denatures protein + changes release kinetics, EtO penetration through alginate shell is unreliable for encapsulated drug.",
            hint:"Protein drug. Every sterilization method has a fatal flaw here. Is terminal sterilization even possible?"
        },
        {
            id:"A011", difficulty:"advanced",
            device_name:"510(k) Regulatory Strategy: Sterilization Method Change",
            material_primary:"HDPE + silicone seal (existing CE-marked product)", material_secondary:null,
            device_description:"CE-marked with gamma sterilization. US 510(k) predicate device used EtO.",
            correct_answers:["GAMMA","ETO"], best_answer:"GAMMA",
            preferred_rationale:"REGULATORY SCENARIO: Both technically work. But switching from predicate's EtO to gamma = must justify equivalence in 510(k). FDA may require sterilization validation data comparing both methods. Matching predicate's EtO would simplify submission (2-3 months vs 4-6 months for gamma justification). Business + regulatory tradeoff, not just material compatibility.",
            rationale:"Regulatory strategy: matching predicate sterilization method simplifies 510(k). Deviation requires additional justification and may extend FDA review.",
            why_mistake_fails:"Neither fails technically. The 'error' is not recognizing the regulatory implications of deviating from predicate sterilization method.",
            hint:"Both methods work technically. What does deviating from the predicate method mean for your 510(k)?"
        },
        {
            id:"A012", difficulty:"advanced",
            device_name:"Nitinol Stent + PEEK Composite (Hybrid)",
            material_primary:"Nitinol frame", material_secondary:"PEEK structural coating sections",
            device_description:"Multi-material stent for complex anatomy, PEEK adds flexibility",
            correct_answers:["ETO"], best_answer:"ETO",
            preferred_rationale:"Nitinol is radiation-stable. PEEK is radiation-sensitive (discoloration + strength loss). PEEK is the LIMITING MATERIAL. This demonstrates that you must build a compatibility matrix for every material in the device and find the common viable method.",
            rationale:"PEEK coating is radiation-sensitive. Even though nitinol tolerates radiation, PEEK dictates EtO.",
            why_mistake_fails:"PEEK discolors brown/black. Strength reduction in PEEK coating affects stent mechanical performance.",
            hint:"Always find the MOST RESTRICTIVE material in a multi-material device. PEEK limits you here."
        }
    ]
};

// ==========================================
// ROUND CONFIGURATION
// ==========================================
const ROUND_CONFIG = {
    1: { type:"compat",    count:8, name:"Round 1: Compatible?",  icon:"üî¨", subtitle:"Is this device compatible with the shown method?" },
    2: { type:"preferred", count:6, name:"Round 2: Best Choice",  icon:"üèÜ", subtitle:"Which method is preferred for this device?" },
    3: { type:"challenge", count:4, name:"Round 3: Expert Mode",  icon:"üß†", subtitle:"Strategy, edge cases, and boss-level decisions" }
};

const ROUND_MESSAGES = {
    1: { emoji:"üî¨", title:"Round 1 Complete!", subtitle:"Solid compatibility knowledge!" },
    2: { emoji:"üèÜ", title:"Round 2 Complete!", subtitle:"You understand method selection!" },
    3: { emoji:"üß†", title:"All Rounds Complete!", subtitle:"Expert-level thinking!" }
};

// ==========================================
// GAME STATE
// ==========================================
let gameState = {
    sessionNumber: 1,
    roundNumber: 1,
    rounds: {
        1: { items:[], idx:0, errors:0, correct:0, done:false },
        2: { items:[], idx:0, errors:0, correct:0, done:false },
        3: { items:[], idx:0, errors:0, correct:0, done:false }
    },
    currentItem: null,
    currentMethod: null,
    score: 0,
    totalErrors: 0,
    currentStreak: 0,
    bestStreak: 0,
    totalAnswered: 0,
    totalCorrect: 0,
    answered: false,
    hintUsed: false
};

// ==========================================
// HELPERS
// ==========================================
function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }
function sample(arr, n){ return shuffle(arr).slice(0, Math.min(n, arr.length)); }

function normalizeItem(item){
    if (!item.preferred_answers){
        const ba = (item.best_answer||"").trim();
        const methodIds = ["ETO","GAMMA","EBEAM","STEAM","VH2O2","ASEPTIC"];
        if(methodIds.includes(ba)){
            item.preferred_answers = [ba];
            item.preferred_type = "single";
        } else if(ba === "ASEPTIC" || item.correct_answers.length === 0){
            item.preferred_answers = ["ASEPTIC"];
            item.preferred_type = "none";
        } else {
            item.preferred_answers = item.correct_answers.slice(0,1);
            item.preferred_type = "single";
        }
    }
    return item;
}

// ==========================================
// LOCAL STORAGE
// ==========================================
function loadSession(){
    const saved = localStorage.getItem('sterileGenius2Session');
    if(saved){ const d=JSON.parse(saved); gameState.sessionNumber = d.sessionNumber||1; }
}
function saveSession(){
    localStorage.setItem('sterileGenius2Session', JSON.stringify({ sessionNumber: gameState.sessionNumber }));
}

// ==========================================
// DIFFICULTY LOGIC
// ==========================================
function getDifficultyLevel(){
    if(gameState.sessionNumber <= 3) return 'foundational';
    if(gameState.sessionNumber <= 6) return 'mixed';
    return 'all';
}

function getAvailableItems(){
    const level = getDifficultyLevel();
    const normalized = ANSWER_KEY.items.map(normalizeItem);
    if(level === 'foundational') return normalized.filter(i=>i.difficulty==='foundational');
    if(level === 'mixed') return normalized.filter(i=>i.difficulty!=='advanced');
    return normalized;
}

// ==========================================
// GAME INITIALIZATION
// ==========================================
function initGame(){
    loadSession();

    const all = getAvailableItems();

    // Round 1: all compatible/incompatible items from difficulty-gated pool
    const pool1 = shuffle(all.filter(i=> i.correct_answers !== undefined));
    // Round 2: items with a clean preferred answer from difficulty-gated pool
    const pool2 = shuffle(all.filter(i=> i.preferred_answers && i.preferred_answers.length > 0 && i.preferred_answers[0] !== 'ASEPTIC'));
    // Round 3 FIX: always pull from ALL items (not difficulty-gated) so advanced questions
    // are always available regardless of session number / difficulty level.
    const allNormalized = ANSWER_KEY.items.map(normalizeItem);
    const pool3 = shuffle(allNormalized.filter(i=> i.difficulty==='advanced'));

    gameState.roundNumber = 1;
    gameState.rounds[1] = { items: sample(pool1, ROUND_CONFIG[1].count), idx:0, errors:0, correct:0, done:false };
    gameState.rounds[2] = { items: sample(pool2, ROUND_CONFIG[2].count), idx:0, errors:0, correct:0, done:false };
    gameState.rounds[3] = { items: sample(pool3, ROUND_CONFIG[3].count), idx:0, errors:0, correct:0, done:false };

    gameState.score = 0;
    gameState.totalErrors = 0;
    gameState.currentStreak = 0;
    gameState.bestStreak = 0;
    gameState.totalAnswered = 0;
    gameState.totalCorrect = 0;
    gameState.answered = false;
    gameState.hintUsed = false;

    // Hide completion/interstitial screens
    document.getElementById('completionScreen').classList.remove('show');
    document.getElementById('roundComplete').classList.remove('show');
    document.getElementById('deviceCard').style.display = 'block';

    updateRoundTracker();
    updateUI();
    loadCurrentQuestion();
}

// ==========================================
// UI UPDATES
// ==========================================
function updateUI(){
    const round = gameState.rounds[gameState.roundNumber];
    const total = round.items.length;
    const idx   = round.idx;

    document.getElementById('sessionNumber').textContent = gameState.sessionNumber;
    document.getElementById('currentItem').textContent = idx;
    document.getElementById('totalItems').textContent = total;
    document.getElementById('scoreDisplay').textContent = gameState.score;
    document.getElementById('errorCount').textContent = gameState.totalErrors;
    document.getElementById('streakCount').textContent = gameState.currentStreak + ' üî•';

    const prog = total > 0 ? (idx / total) * 100 : 0;
    document.getElementById('progressBar').style.width = prog + '%';

    const level = getDifficultyLevel();
    const badge = document.getElementById('difficultyBadge');
    badge.className = 'difficulty-badge';
    if(level === 'foundational'){ badge.classList.add('difficulty-foundational'); badge.textContent = 'Beginner Mode'; }
    else if(level === 'mixed')  { badge.classList.add('difficulty-intermediate'); badge.textContent = 'Intermediate Mode'; }
    else                        { badge.classList.add('difficulty-advanced');     badge.textContent = 'Advanced Mode'; }
}

// ==========================================
// ROUND TRACKER
// ==========================================
function updateRoundTracker(){
    [1,2,3].forEach(r => {
        const row    = document.getElementById('roundRow'+r);
        const status = document.getElementById('roundStatus'+r);
        const rd     = gameState.rounds[r];
        row.classList.remove('active','done');
        status.className = 'round-status';
        if(rd.done){
            row.classList.add('done');
            status.classList.add('status-done');
            status.textContent = '‚úì';
        } else if(r === gameState.roundNumber){
            row.classList.add('active');
            status.classList.add('status-in-progress');
            status.textContent = rd.idx + '/' + rd.items.length;
        } else {
            status.classList.add('status-not-started');
            status.textContent = '‚Äî';
        }
    });
}

// ==========================================
// SWIPE / PICK MODE TOGGLE
// ==========================================
function setMode(mode){
    document.getElementById('swipeMode').classList.toggle('hidden', mode !== 'swipe');
    document.getElementById('pickMode').classList.toggle('hidden', mode !== 'pick');
}

// ==========================================
// LOAD CURRENT QUESTION
// ==========================================
function loadCurrentQuestion(){
    const round = gameState.rounds[gameState.roundNumber];
    const item  = round.items[round.idx];
    if(!item) return;

    gameState.currentItem  = item;
    gameState.answered     = false;
    gameState.hintUsed     = false;

    // Render card
    const diffMap   = { foundational:'tag-foundational', intermediate:'tag-intermediate', advanced:'tag-advanced' };
    const diffLabel = { foundational:'Foundational', intermediate:'Intermediate', advanced:'Advanced' };
    const tag = document.getElementById('difficultyTag');
    tag.className   = 'difficulty-tag ' + (diffMap[item.difficulty] || 'tag-foundational');
    tag.textContent = diffLabel[item.difficulty] || item.difficulty;

    document.getElementById('deviceName').textContent        = item.device_name;
    document.getElementById('deviceDescription').textContent = item.device_description || '';
    document.getElementById('materialPrimary').textContent   = item.material_primary || '';

    const secRow = document.getElementById('materialSecondaryRow');
    if(item.material_secondary){
        secRow.style.display = 'flex';
        document.getElementById('materialSecondary').textContent = item.material_secondary;
    } else {
        secRow.style.display = 'none';
    }

    // Round banner
    const cfg = ROUND_CONFIG[gameState.roundNumber];
    document.getElementById('roundBanner').querySelector('.round-banner-icon').textContent = cfg.icon;
    document.getElementById('roundBannerTitle').textContent = cfg.name;
    document.getElementById('roundBannerSub').textContent   = cfg.subtitle;

    // Hide feedback + hint
    document.getElementById('feedbackArea').classList.remove('show');
    document.getElementById('hintDisplay').classList.remove('show');
    document.getElementById('hintDisplay').textContent = '';
    document.getElementById('btnHint').disabled = false;
    document.getElementById('deviceCard').classList.remove('correct-answer','wrong-answer');

    // Set mode
    if(cfg.type === 'compat'){
        setMode('swipe');
        loadCompatPrompt(item);
        document.getElementById('btnCompatible').disabled   = false;
        document.getElementById('btnIncompatible').disabled = false;
    } else {
        setMode('pick');
        loadPickPrompt(item, cfg.type);
    }

    updateUI();
    updateRoundTracker();
}

function loadCompatPrompt(item){
    const methods = ANSWER_KEY.sterilizationMethods;
    gameState.currentMethod = methods[Math.floor(Math.random() * methods.length)];
    document.getElementById('currentMethod').textContent =
        ANSWER_KEY.methodDetails[gameState.currentMethod].name;
}

function loadPickPrompt(item, rType){
    document.getElementById('pickPrompt').textContent =
        rType === 'challenge'
            ? 'What is the best sterilization strategy for this device?'
            : 'Which method is preferred for this device?';

    const ctx = document.getElementById('pickContext');
    if(item.device_description && rType === 'challenge'){
        ctx.textContent = item.device_description;
        ctx.classList.add('show');
    } else {
        ctx.classList.remove('show');
    }

    const options = [...ANSWER_KEY.sterilizationMethods];
    if(rType === 'challenge') options.push('ASEPTIC');

    const host = document.getElementById('methodOptions');
    host.innerHTML = '';
    options.forEach(id => {
        const btn = document.createElement('button');
        btn.className   = 'method-option-btn';
        btn.dataset.mid = id;
        btn.innerHTML   = '<strong>' + ANSWER_KEY.methodDetails[id].name + '</strong><br>'
                        + '<span style="font-size:11px;color:#94a3b8;">' + ANSWER_KEY.methodDetails[id].temp + '</span>';
        btn.onclick = () => checkPickAnswer(id, rType);
        host.appendChild(btn);
    });
}

// ==========================================
// CHECK ANSWERS
// ==========================================
function checkAnswer(userSaysCompatible){
    if(gameState.answered) return;
    gameState.answered = true;

    const item     = gameState.currentItem;
    const method   = gameState.currentMethod;
    const actually = item.correct_answers.includes(method);
    const correct  = (userSaysCompatible === actually);

    document.getElementById('btnCompatible').disabled   = true;
    document.getElementById('btnIncompatible').disabled = true;

    if(correct){
        gameState.score += 100;
        gameState.currentStreak++;
        gameState.totalCorrect++;
        if(gameState.currentStreak > gameState.bestStreak) gameState.bestStreak = gameState.currentStreak;
        if(gameState.currentStreak > 0 && gameState.currentStreak % 5 === 0) gameState.score += 50;
        gameState.rounds[gameState.roundNumber].correct++;
        document.getElementById('deviceCard').classList.add('correct-answer');
    } else {
        gameState.score       = Math.max(0, gameState.score - 50);
        gameState.totalErrors++;
        gameState.currentStreak = 0;
        gameState.rounds[gameState.roundNumber].errors++;
        document.getElementById('deviceCard').classList.add('wrong-answer');
    }
    gameState.totalAnswered++;

    let text = '';
    if(correct && userSaysCompatible)   text = `Yes ‚Äî ${ANSWER_KEY.methodDetails[method].name} is compatible with this device.`;
    if(correct && !userSaysCompatible)  text = `Right ‚Äî ${ANSWER_KEY.methodDetails[method].name} is NOT compatible with this device.`;
    if(!correct && userSaysCompatible)  text = `Actually, ${ANSWER_KEY.methodDetails[method].name} is NOT compatible with this device.`;
    if(!correct && !userSaysCompatible) text = `Actually, ${ANSWER_KEY.methodDetails[method].name} IS compatible with this device.`;

    const icon  = correct ? '‚úÖ' : '‚ùå';
    const title = correct ? 'Correct!' : 'Incorrect';
    const cls   = correct ? 'feedback-correct' : 'feedback-wrong';
    showFeedback(icon, title, cls, text, item.rationale || '');
    updateUI();
}

function checkPickAnswer(selectedMethod, rType){
    if(gameState.answered) return;
    gameState.answered = true;

    const item      = gameState.currentItem;
    const preferred = item.preferred_answers || [];
    const isCorrect = preferred.includes(selectedMethod);
    const isCompatible = selectedMethod === 'ASEPTIC'
        ? (item.correct_answers || []).length === 0
        : (item.correct_answers || []).includes(selectedMethod);

    // Highlight buttons
    document.querySelectorAll('.method-option-btn').forEach(btn => {
        btn.disabled = true;
        if(btn.dataset.mid === selectedMethod){
            btn.classList.add(isCorrect ? 'selected-correct' : 'selected-wrong');
        }
        if(!isCorrect && preferred.includes(btn.dataset.mid)){
            btn.classList.add('reveal-correct');
        }
    });

    let icon, title, cls, text;

    if(isCorrect){
        gameState.score += 100;
        gameState.currentStreak++;
        gameState.totalCorrect++;
        if(gameState.currentStreak > gameState.bestStreak) gameState.bestStreak = gameState.currentStreak;
        if(gameState.currentStreak > 0 && gameState.currentStreak % 5 === 0) gameState.score += 50;
        gameState.rounds[gameState.roundNumber].correct++;
        document.getElementById('deviceCard').classList.add('correct-answer');
        icon  = '‚úÖ'; title = 'Correct!'; cls = 'feedback-correct';
        text  = 'That is the preferred method.';
    } else if(isCompatible && selectedMethod !== 'ASEPTIC'){
        gameState.score = Math.max(0, gameState.score - 25);
        gameState.totalErrors++;
        gameState.currentStreak = 0;
        gameState.rounds[gameState.roundNumber].errors++;
        document.getElementById('deviceCard').classList.add('wrong-answer');
        icon  = '‚ö†Ô∏è'; title = 'Compatible, but not preferred'; cls = 'feedback-warn';
        text  = ANSWER_KEY.methodDetails[selectedMethod].name
              + ' would likely work, but '
              + preferred.map(p => ANSWER_KEY.methodDetails[p]?.name || p).join(' / ')
              + ' is preferred.';
    } else {
        gameState.score = Math.max(0, gameState.score - 50);
        gameState.totalErrors++;
        gameState.currentStreak = 0;
        gameState.rounds[gameState.roundNumber].errors++;
        document.getElementById('deviceCard').classList.add('wrong-answer');
        icon  = '‚ùå'; title = 'Incorrect'; cls = 'feedback-wrong';
        text  = 'The preferred method is: '
              + preferred.map(p => ANSWER_KEY.methodDetails[p]?.name || p).join(' / ') + '.';
    }
    gameState.totalAnswered++;

    const rationale = item.preferred_rationale || item.rationale || '';
    showFeedback(icon, title, cls, text, rationale);
    updateUI();
}

// ==========================================
// SHOW FEEDBACK
// ==========================================
function showFeedback(icon, title, cls, text, rationale){
    document.getElementById('feedbackIcon').textContent  = icon;
    document.getElementById('feedbackTitle').textContent = title;
    document.getElementById('feedbackTitle').className   = 'feedback-title ' + cls;
    document.getElementById('feedbackText').textContent  = text;
    document.getElementById('rationaleText').textContent = rationale;
    document.getElementById('feedbackArea').classList.add('show');
    setTimeout(() => {
        document.getElementById('feedbackArea').scrollIntoView({ behavior:'smooth', block:'nearest' });
    }, 100);
}

// ==========================================
// HINT
// ==========================================
function showHint(){
    if(gameState.answered || gameState.hintUsed) return;
    gameState.hintUsed = true;
    gameState.score    = Math.max(0, gameState.score - 20);
    const hint = gameState.currentItem.hint || 'No hint available.';
    document.getElementById('hintDisplay').textContent = 'üí° ' + hint;
    document.getElementById('hintDisplay').classList.add('show');
    document.getElementById('btnHint').disabled = true;
    updateUI();
}

// ==========================================
// NEXT ITEM / ROUND ADVANCE
// ==========================================
function nextItem(){
    const rn    = gameState.roundNumber;
    const round = gameState.rounds[rn];
    round.idx++;

    document.getElementById('deviceCard').classList.remove('correct-answer','wrong-answer');

    if(round.idx >= round.items.length){
        round.done = true;
        updateRoundTracker();
        if(rn < 3){
            showRoundComplete(rn);
        } else {
            showCompletionScreen();
        }
    } else {
        loadCurrentQuestion();
    }
}

// ==========================================
// ROUND COMPLETE INTERSTITIAL
// ==========================================
function showRoundComplete(completedRound){
    const round    = gameState.rounds[completedRound];
    const total    = round.items.length;
    const correct  = round.correct;
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

    const msgs = ROUND_MESSAGES[completedRound];
    document.getElementById('rcEmoji').textContent    = msgs.emoji;
    document.getElementById('rcTitle').textContent    = msgs.title;
    document.getElementById('rcSubtitle').textContent = msgs.subtitle;
    document.getElementById('rcAccuracy').textContent = accuracy + '%';
    document.getElementById('rcErrors').textContent   = round.errors;

    document.getElementById('deviceCard').style.display = 'none';
    document.getElementById('roundComplete').classList.add('show');
}

function continueToNextRound(){
    gameState.roundNumber++;
    document.getElementById('roundComplete').classList.remove('show');
    document.getElementById('deviceCard').style.display = 'block';
    updateRoundTracker();
    loadCurrentQuestion();
}

// ==========================================
// SESSION COMPLETE
// ==========================================
function showCompletionScreen(){
    const total    = gameState.totalAnswered;
    const correct  = gameState.totalCorrect;
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

    document.getElementById('finalAccuracy').textContent = accuracy + '%';
    document.getElementById('finalScore').textContent    = gameState.score;
    document.getElementById('finalStreak').textContent   = gameState.bestStreak + ' üî•';

    document.getElementById('deviceCard').style.display = 'none';
    document.getElementById('completionScreen').classList.add('show');

    gameState.sessionNumber++;
    saveSession();
}

// ==========================================
// EVENT LISTENERS
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnCompatible').addEventListener('click',   () => checkAnswer(true));
    document.getElementById('btnIncompatible').addEventListener('click', () => checkAnswer(false));
    document.getElementById('btnNext').addEventListener('click',         nextItem);
    document.getElementById('btnHint').addEventListener('click',         showHint);
    document.getElementById('btnNewSession').addEventListener('click',   initGame);
    document.getElementById('btnNextRound').addEventListener('click',    continueToNextRound);
    document.getElementById('btnNewSessionComplete').addEventListener('click', initGame);

    document.addEventListener('keydown', e => {
        if(gameState.answered) return;
        const rType = ROUND_CONFIG[gameState.roundNumber]?.type;
        if(rType === 'compat'){
            if(e.key === 'ArrowLeft'  || e.key === 'x' || e.key === 'X') checkAnswer(false);
            if(e.key === 'ArrowRight' || e.key === 'c' || e.key === 'C') checkAnswer(true);
        }
        if(e.key === 'h' || e.key === 'H') showHint();
    });

    initGame();
});
</script>
</body>
</html>
