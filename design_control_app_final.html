<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Control Interactive Learning | BE695</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.1);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.15);
            --shadow-xl: 0 24px 64px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Beautiful Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 4px 0 32px rgba(0,0,0,0.1);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid rgba(102, 126, 234, 0.1);
        }

        .sidebar-logo {
            font-size: 14px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 6px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .sidebar-title {
            font-size: 24px;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: #718096;
            line-height: 1.6;
            margin-bottom: 32px;
            font-weight: 500;
        }

        .nav-btn {
            padding: 18px 20px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border: 2px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 700;
            color: #4a5568;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-sm);
        }

        .nav-btn .icon {
            font-size: 22px;
            transition: transform 0.3s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .nav-btn:hover .icon {
            transform: scale(1.15) rotate(5deg);
        }

        .nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            border-color: rgba(255,255,255,0.2);
        }

        .nav-btn.active .icon {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }

        .progress-section {
            margin-top: auto;
            padding-top: 28px;
            border-top: 2px solid #e2e8f0;
        }

        .progress-title {
            font-size: 11px;
            font-weight: 800;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 16px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 13px;
            color: #4a5568;
            font-weight: 600;
        }

        .progress-badges {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .progress-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: var(--shadow-sm);
        }

        .progress-badge.complete { background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); color: #22543d; }
        .progress-badge.in-progress { background: linear-gradient(135deg, #feebc8 0%, #fbd38d 100%); color: #7c2d12; }
        .progress-badge.not-started { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); color: #718096; }

        .error-badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 800;
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
            box-shadow: var(--shadow-sm);
        }

        /* Main Content */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 48px;
            overflow-y: auto;
            height: 100vh;
        }

        .screen { display: none; animation: fadeIn 0.5s ease-out; }
        .screen.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 28px;
            padding: 56px;
            box-shadow: var(--shadow-xl);
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid rgba(255,255,255,0.8);
        }

        h2 {
            font-size: 42px;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -1.5px;
        }

        .subtitle {
            font-size: 18px;
            color: #718096;
            margin-bottom: 40px;
            line-height: 1.7;
            font-weight: 500;
        }

        /* Beautiful Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: inherit;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn > * { position: relative; z-index: 1; }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }

        /* Home Screen */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 32px;
            margin-top: 40px;
        }

        .module-card {
            position: relative;
            padding: 40px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s;
        }

        .module-card:hover::before {
            transform: scale(1);
        }

        .module-card > * {
            position: relative;
            z-index: 1;
        }

        .module-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 28px 64px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .module-card h3 {
            font-size: 26px;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 14px;
        }

        .module-card p {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .module-card .meta {
            display: flex;
            gap: 18px;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
        }

        .module-card.part1 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .module-card.part2 { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .module-card.part3 { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
        .module-card.part3 h3, .module-card.part3 p { color: white; }
        .module-card.part3 .meta { color: rgba(255,255,255,0.9); }

        /* Part 1: Keep as is */
        .sorting-container {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 40px;
            margin-top: 40px;
        }

        .card-pool {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 32px;
            border-radius: 24px;
            min-height: 500px;
            border: 3px dashed #cbd5e0;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.03);
        }

        .card-pool h4 {
            margin-bottom: 24px;
            color: #4a5568;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .cards-wrapper {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .statement-card {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            padding: 18px 24px;
            border-radius: 14px;
            border: 2px solid #e2e8f0;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            line-height: 1.7;
            box-shadow: var(--shadow-sm);
            font-weight: 600;
            color: #2d3748;
        }

        .statement-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            background: white;
        }

        .statement-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(0.95);
        }

        .statement-card.correct {
            border-color: #48bb78;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }

        .statement-card.incorrect {
            border-color: #f56565;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            animation: shake 0.6s;
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.3);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        .buckets { display: flex; flex-direction: column; gap: 18px; }

        .bucket {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px dashed #cbd5e0;
            border-radius: 18px;
            padding: 20px;
            min-height: 150px;
            transition: all 0.3s;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.02);
        }

        .bucket.drag-over {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6edff 100%);
            border-color: #667eea;
            border-style: solid;
            transform: scale(1.03);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .bucket-header {
            font-weight: 800;
            margin-bottom: 14px;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: var(--shadow-sm);
        }

        .bucket.user-need .bucket-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
        }

        .bucket.design-input .bucket-header {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #6a1b9a;
        }

        .bucket.design-output .bucket-header {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
        }

        .bucket-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .completion-status {
            background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);
            padding: 18px 24px;
            border-radius: 14px;
            margin-bottom: 24px;
            font-size: 15px;
            font-weight: 700;
            color: #0c5282;
            text-align: center;
            display: none;
            box-shadow: var(--shadow-sm);
            border: 2px solid #91d5ff;
        }

        .completion-status.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            gap: 14px;
            margin-top: 36px;
            padding-top: 28px;
            border-top: 3px solid #e2e8f0;
            flex-wrap: wrap;
        }

        /* Part 2: Build Requirements */
        .challenge-container { margin-top: 40px; }

        .challenge-header {
            background: var(--primary-gradient);
            padding: 32px 36px;
            border-radius: 20px;
            margin-bottom: 36px;
            color: white;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .challenge-header h3 {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 14px;
            color: white;
        }

        .challenge-header .user-need {
            font-size: 16px;
            font-style: italic;
            padding: 18px 22px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            margin-top: 14px;
            line-height: 1.7;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: 500;
        }

        .builder-form { display: flex; flex-direction: column; gap: 28px; }

        .form-group {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 28px;
            border-radius: 18px;
            border: 2px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
        }

        .form-label {
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 14px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
            background: white;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .options-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 14px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            box-shadow: var(--shadow-sm);
        }

        .option-item:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            transform: translateX(4px);
        }

        .option-item input[type="radio"] {
            margin-right: 14px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .option-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6edff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .built-requirement {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 28px;
            border-radius: 18px;
            border-left: 8px solid #667eea;
            margin: 28px 0;
            font-size: 17px;
            line-height: 1.9;
            min-height: 80px;
            font-weight: 700;
            color: #2d3748;
            box-shadow: var(--shadow-md);
        }

        .feedback {
            padding: 22px 28px;
            border-radius: 16px;
            margin-top: 28px;
            font-size: 15px;
            display: none;
            line-height: 1.7;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .feedback.show { display: block; animation: slideIn 0.5s; }

        .feedback.success {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-left: 8px solid #48bb78;
            color: #22543d;
        }

        .feedback.error {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border-left: 8px solid #f56565;
            color: #742a2a;
        }

        .challenge-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 36px;
            padding-top: 28px;
            border-top: 3px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .challenge-progress {
            font-size: 15px;
            color: #718096;
            font-weight: 700;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        /* Part 3: Trace Matrix */
        .trace-container {
            margin-top: 40px;
        }

        .trace-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 36px;
        }

        .trace-column {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 24px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            box-shadow: var(--shadow-md);
        }

        .trace-column h4 {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 18px;
            padding: 10px 14px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .trace-column.need h4 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
        }

        .trace-column.input h4 {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #6a1b9a;
        }

        .trace-column.output h4 {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
        }

        .trace-column.test h4 {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            color: #22543d;
        }

        .trace-cards-col {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .trace-card {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            line-height: 1.6;
            font-weight: 600;
            color: #2d3748;
            box-shadow: var(--shadow-sm);
        }

        .trace-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: #667eea;
        }

        .trace-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6edff 100%);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            transform: scale(1.03);
        }

        .trace-card.linked {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .trace-card.correct-link {
            border-color: #48bb78;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }

        .chains-summary {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 28px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            margin-top: 28px;
            box-shadow: var(--shadow-md);
        }

        .chains-summary h4 {
            font-size: 18px;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .completed-chain {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 14px;
            border-left: 8px solid #48bb78;
            box-shadow: var(--shadow-sm);
        }

        .completed-chain .chain-device {
            font-weight: 800;
            color: #22543d;
            margin-bottom: 8px;
            font-size: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 48px;
            border-radius: 28px;
            max-width: 560px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.4);
            animation: modalPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 18px;
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-content p {
            color: #4a5568;
            line-height: 1.8;
            margin-bottom: 28px;
            font-size: 16px;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .sidebar { width: 260px; }
            .main-content { margin-left: 260px; }
            .sorting-container, .trace-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo">BE 695</div>
        <div class="sidebar-title">Design Control Learning</div>
        <div class="sidebar-subtitle">Master user needs, design inputs, and design outputs</div>

        <button class="nav-btn active" onclick="showScreen('home')">
            <span class="icon">üè†</span><span>Home</span>
        </button>

        <button class="nav-btn" onclick="showScreen('part1')">
            <span class="icon">üì¶</span><span>Sorting Game</span>
        </button>

        <button class="nav-btn" onclick="showScreen('part2')">
            <span class="icon">üî®</span><span>Build Requirements</span>
        </button>

        <button class="nav-btn" onclick="showScreen('part3')">
            <span class="icon">üîó</span><span>Trace Matrix</span>
        </button>

        <div class="progress-section">
            <div class="progress-title">Your Progress</div>

            <div class="progress-item">
                <span>Sorting</span>
                <div class="progress-badges">
                    <span class="error-badge" id="errors-part1" style="display:none;">0 ‚úó</span>
                    <span class="progress-badge not-started" id="progress-part1">Not Started</span>
                </div>
            </div>

            <div class="progress-item">
                <span>Build</span>
                <div class="progress-badges">
                    <span class="error-badge" id="errors-part2" style="display:none;">0 ‚úó</span>
                    <span class="progress-badge not-started" id="progress-part2">Not Started</span>
                </div>
            </div>

            <div class="progress-item">
                <span>Trace</span>
                <div class="progress-badges">
                    <span class="error-badge" id="errors-part3" style="display:none;">0 ‚úó</span>
                    <span class="progress-badge not-started" id="progress-part3">Not Started</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div id="home" class="screen active">
            <div class="content-card">
                <h2>Welcome to Design Control</h2>
                <p class="subtitle">Master the fundamentals of translating user needs into design requirements and specifications through three interactive exercises.</p>

                <div class="module-grid">
                    <div class="module-card part1" onclick="showScreen('part1')">
                        <h3>üì¶ Sorting Game</h3>
                        <p>Sort 12 statements into User Needs, Design Inputs, and Design Outputs. Build intuition for distinguishing clinical needs from engineering requirements.</p>
                        <div class="meta">
                            <span>‚è±Ô∏è 5-7 min</span>
                            <span>üìä 12 statements</span>
                            <span>‚ôæÔ∏è Unlimited</span>
                        </div>
                    </div>

                    <div class="module-card part2" onclick="showScreen('part2')">
                        <h3>üî® Build Requirements</h3>
                        <p>Construct proper Design Inputs using structured selections. Learn the grammar of testable, quantitative requirements.</p>
                        <div class="meta">
                            <span>‚è±Ô∏è 6-8 min</span>
                            <span>üìä 4 challenges</span>
                            <span>üîÑ Unlimited checks</span>
                        </div>
                    </div>

                    <div class="module-card part3" onclick="showScreen('part3')">
                        <h3>üîó Trace Matrix</h3>
                        <p>Match cards to build complete traceability chains: Need ‚Üí Input ‚Üí Output ‚Üí Test. Master FDA design control flow.</p>
                        <div class="meta">
                            <span>‚è±Ô∏è 7-10 min</span>
                            <span>üìä 3 chains</span>
                            <span>‚ôæÔ∏è Unlimited</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="part1" class="screen">
            <div class="content-card">
                <h2>Sorting Game</h2>
                <p class="subtitle">Drag each statement into the correct category. All 12 cards must be placed to check your answers.</p>

                <div class="completion-status" id="completion-status"></div>

                <div class="sorting-container">
                    <div class="card-pool">
                        <h4>Drag Statements to Buckets ‚Üí</h4>
                        <div class="cards-wrapper" id="card-pool"></div>
                    </div>

                    <div class="buckets">
                        <div class="bucket user-need" data-category="User Need" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="bucket-header">User Needs</div>
                            <div class="bucket-cards" id="bucket-user-need"></div>
                        </div>

                        <div class="bucket design-input" data-category="Design Input" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="bucket-header">Design Inputs</div>
                            <div class="bucket-cards" id="bucket-design-input"></div>
                        </div>

                        <div class="bucket design-output" data-category="Design Output" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="bucket-header">Design Outputs</div>
                            <div class="bucket-cards" id="bucket-design-output"></div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="checkSorting()" id="check-btn">‚úì Check My Work</button>
                    <button class="btn btn-warning" onclick="showAnswer()">üí° Show Answer</button>
                    <button class="btn btn-secondary" onclick="resetSorting()">‚Ü∫ New Session</button>
                </div>
            </div>
        </div>

        <div id="part2" class="screen">
            <div class="content-card">
                <h2>Build Requirements</h2>
                <p class="subtitle">Construct a proper Design Input by selecting the correct components. All requirements use "shall" as the modal verb.</p>
                <div class="challenge-container" id="challenge-container"></div>
            </div>
        </div>

        <div id="part3" class="screen">
            <div class="content-card">
                <h2>Trace Matrix</h2>
                <p class="subtitle">Click cards from different columns to link them. Complete all 3 chains by connecting Need ‚Üí Input ‚Üí Output ‚Üí Test.</p>

                <div class="trace-container">
                    <div class="trace-grid" id="trace-grid"></div>

                    <div class="chains-summary">
                        <h4>Completed Chains (<span id="chains-count">0</span>/3)</h4>
                        <div id="completed-chains"></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-secondary" onclick="resetTraceMatrix()">‚Ü∫ New Session</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chain-modal" class="modal">
        <div class="modal-content">
            <h3>‚úÖ Chain Complete!</h3>
            <p id="modal-text"></p>
            <button class="btn btn-primary" onclick="closeModal()">Continue</button>
        </div>
    </div>

    <script>
        const part1Data = [{"id": 1, "statement": "User must be able to visualize structures throughout the shoulder space", "category": "User Need"}, {"id": 2, "statement": "Instruments must be reprocessable to achieve sterility assurance", "category": "User Need"}, {"id": 3, "statement": "Product must be provided ready for surgery", "category": "User Need"}, {"id": 4, "statement": "Device should allow for minimally invasive procedures", "category": "User Need"}, {"id": 5, "statement": "Device should enable access to small anatomical spaces without tissue damage", "category": "User Need"}, {"id": 6, "statement": "Device should provide clear visualization of the surgical area", "category": "User Need"}, {"id": 7, "statement": "Camera system must be suitable for arthroscopic surgery", "category": "User Need"}, {"id": 8, "statement": "Handpiece shall maintain a clear field of view throughout surgery", "category": "User Need"}, {"id": 9, "statement": "Implant device suitable to complete soft tissue repair procedures", "category": "User Need"}, {"id": 10, "statement": "Device must have ability to be cleaned by user", "category": "User Need"}, {"id": 11, "statement": "Patient needs to know glucose level in blood", "category": "User Need"}, {"id": 12, "statement": "Surgeon needs access through one portal to multiple viewing angles", "category": "User Need"}, {"id": 13, "statement": "Device must have outer diameter of no more than 5 mm", "category": "Design Input"}, {"id": 14, "statement": "Device must provide 30-degree field of view", "category": "Design Input"}, {"id": 15, "statement": "Device must withstand force of 10 Newtons without permanent deformation", "category": "Design Input"}, {"id": 16, "statement": "Device must withstand standard hospital autoclave sterilization procedures", "category": "Design Input"}, {"id": 17, "statement": "Product shall demonstrate sterility assurance level of 10^-6 per ANSI/AAMI ST67:2003", "category": "Design Input"}, {"id": 18, "statement": "Packaging seal strength shall be greater than 1 lb", "category": "Design Input"}, {"id": 19, "statement": "Autoclavable camera shall provide an image with MTF values of XX following 500 standard re-processing cycles", "category": "Design Input"}, {"id": 20, "statement": "Brightness level shall be configurable within range of X-Z using the GUI", "category": "Design Input"}, {"id": 21, "statement": "Scope must come in 0\u00b0, 30\u00b0, and 70\u00b0 tip angles", "category": "Design Input"}, {"id": 22, "statement": "Device shall exhibit no visible corrosion after exposure to representative cleaning chemicals and steam sterilization", "category": "Design Input"}, {"id": 23, "statement": "Device shall maintain functionality and meet dimensional tolerances after 500 standard hospital reprocessing cycles", "category": "Design Input"}, {"id": 24, "statement": "Device shall measure glucose from 20-600 mg/dL with \u00b115% accuracy", "category": "Design Input"}, {"id": 25, "statement": "Aspiration socket shall have pull-out force of minimum 10.5 lbs", "category": "Design Input"}, {"id": 26, "statement": "Screw shall have minimum 250 N pull-out strength at t=0 in 25D foam", "category": "Design Input"}, {"id": 27, "statement": "Device must withstand minimum 250 N pull-out force without permanent deformation", "category": "Design Input"}, {"id": 28, "statement": "Device shall achieve residue levels of no more than 6.4 \u03bcg/cm\u00b2 protein after cleaning per IFU", "category": "Design Input"}, {"id": 29, "statement": "Sensor uses glucose oxidase enzyme on platinum electrode per Drawing GS-001", "category": "Design Output"}, {"id": 30, "statement": "Drawing Reference: Drawing 123 Rev A, Dimension X \u00b1 Y", "category": "Design Output"}, {"id": 31, "statement": "Material: 17-4 Stainless Steel", "category": "Design Output"}, {"id": 32, "statement": "Apply 0.5g Loctite to socket per Assembly Work Instruction 103xxx", "category": "Design Output"}, {"id": 33, "statement": "Minimum interference 0.010 inches per Assembly Drawing 103xxxx", "category": "Design Output"}, {"id": 34, "statement": "Minimum wall thickness = 0.250 inches, Pitch = 0.080 inches", "category": "Design Output"}, {"id": 35, "statement": "Screw length = 1.025 \u00b1 0.010 inches, Material shall be PEEK per Drawing 103XXXX", "category": "Design Output"}, {"id": 36, "statement": "Internal lumen diameter = 0.5 in, Lumen length = 2 in, Material = 17-4 SS per Drawing 103XXXX", "category": "Design Output"}, {"id": 37, "statement": "Scope tip angle: 30\u00b0 \u00b1 2\u00b0 per Drawing SC-045 Rev C", "category": "Design Output"}, {"id": 38, "statement": "Use 316L stainless steel with yield strength of 205 MPa", "category": "Design Output"}, {"id": 39, "statement": "Assembly per Work Instruction WI-ASM-001 Rev B", "category": "Design Output"}, {"id": 40, "statement": "Label text: 'Sterile unless package is damaged' per Label Drawing LBL-123", "category": "Design Output"}];
        const part2Data = [{"challenge_id": 1, "device_context": "Arthroscope - Durability", "user_need": "Device should enable access to small anatomical spaces without tissue damage", "correct_design_input": "Device shall withstand force of 10 Newtons without permanent deformation", "subject": "Device", "action_verb": "withstand", "quantifier": "force of 10", "quantifier_options": ["force of 10", "force of 15", "force of 5"], "unit": "Newtons", "qualifier": "without permanent deformation", "qualifier_options": ["without permanent deformation", "without visible damage", "at room temperature"]}, {"challenge_id": 2, "device_context": "Glucose Meter - Accuracy", "user_need": "Patient needs to know glucose level in blood", "correct_design_input": "Device shall measure glucose concentration from 20-600 mg/dL with \u00b115% accuracy", "subject": "Device", "action_verb": "measure", "quantifier": "glucose concentration from 20-600", "quantifier_options": ["glucose concentration from 20-600", "glucose concentration from 50-500", "glucose concentration from 10-800"], "unit": "mg/dL", "qualifier": "with \u00b115% accuracy", "qualifier_options": ["with \u00b115% accuracy", "with \u00b110% accuracy", "with \u00b120% accuracy"]}, {"challenge_id": 3, "device_context": "Arthroscope - Size Constraint", "user_need": "Device should allow for minimally invasive procedures", "correct_design_input": "Device shall have outer diameter of no more than 5 mm", "subject": "Device", "action_verb": "have", "quantifier": "outer diameter of no more than 5", "quantifier_options": ["outer diameter of no more than 5", "outer diameter of no more than 8", "outer diameter of no more than 3"], "unit": "mm", "qualifier": "measured at widest point", "qualifier_options": ["measured at widest point", "at the distal tip", "along the entire length"]}, {"challenge_id": 4, "device_context": "Surgical Screw - Mechanical Strength", "user_need": "Implant device suitable to complete soft tissue repair procedures", "correct_design_input": "Screw shall have minimum 250 N pull-out strength at t=0 in 25D foam", "subject": "Screw", "action_verb": "have", "quantifier": "minimum 250", "quantifier_options": ["minimum 250", "minimum 200", "minimum 300"], "unit": "N", "qualifier": "pull-out strength at t=0 in 25D foam", "qualifier_options": ["pull-out strength at t=0 in 25D foam", "pull-out strength at t=0 in 20D foam", "tensile strength in air"]}, {"challenge_id": 5, "device_context": "Reusable Instrument - Sterilization", "user_need": "Instruments must be reprocessable to achieve sterility assurance", "correct_design_input": "Device shall withstand 500 standard hospital re-processing cycles without loss of function", "subject": "Device", "action_verb": "withstand", "quantifier": "500", "quantifier_options": ["500", "300", "1000"], "unit": "re-processing cycles", "qualifier": "without loss of function", "qualifier_options": ["without loss of function", "without visible degradation", "at standard temperature"]}, {"challenge_id": 6, "device_context": "Arthroscope Camera - Field of View", "user_need": "Device should provide clear visualization of the surgical area", "correct_design_input": "Device shall provide a 30-degree field of view at 10 mm working distance", "subject": "Device", "action_verb": "provide", "quantifier": "30-degree field of view at 10", "quantifier_options": ["30-degree field of view at 10", "45-degree field of view at 10", "30-degree field of view at 15"], "unit": "mm", "qualifier": "working distance", "qualifier_options": ["working distance", "focal length", "from the tissue surface"]}, {"challenge_id": 7, "device_context": "Sterile Packaging - Seal Integrity", "user_need": "Product must be provided ready for surgery", "correct_design_input": "Packaging seal strength shall be greater than 1 lb", "subject": "Packaging seal strength", "action_verb": "be", "quantifier": "greater than 1", "quantifier_options": ["greater than 1", "greater than 2", "greater than 0.5"], "unit": "lb", "qualifier": "when tested per defined seal-strength method", "qualifier_options": ["when tested per defined seal-strength method", "at room temperature", "after sterilization"]}, {"challenge_id": 8, "device_context": "Aspiration Socket - Connection Strength", "user_need": "Handpiece shall maintain a clear field of view throughout surgery", "correct_design_input": "Aspiration socket shall have pull-out force of minimum 10.5 lbs", "subject": "Aspiration socket", "action_verb": "have", "quantifier": "pull-out force of minimum 10.5", "quantifier_options": ["pull-out force of minimum 10.5", "pull-out force of minimum 8", "pull-out force of minimum 12"], "unit": "lbs", "qualifier": "when tested per internal test method", "qualifier_options": ["when tested per internal test method", "at room temperature", "under typical use conditions"]}, {"challenge_id": 9, "device_context": "Cleaning Validation - Residue Limits", "user_need": "Device must have ability to be cleaned by user", "correct_design_input": "Device shall achieve residue levels of no more than 6.4 \u03bcg/cm\u00b2 protein after cleaning per IFU", "subject": "Device", "action_verb": "achieve", "quantifier": "residue levels of no more than 6.4", "quantifier_options": ["residue levels of no more than 6.4", "residue levels of no more than 10", "residue levels of no more than 5"], "unit": "\u03bcg/cm\u00b2", "qualifier": "protein after cleaning per IFU", "qualifier_options": ["protein after cleaning per IFU", "protein after sterilization", "total organic residue"]}, {"challenge_id": 10, "device_context": "Camera Resolution - Image Quality", "user_need": "Camera system must be suitable for arthroscopic surgery", "correct_design_input": "Autoclavable camera shall provide an image with MTF values of XX following 500 standard re-processing cycles", "subject": "Camera", "action_verb": "provide", "quantifier": "MTF values of XX following 500", "quantifier_options": ["MTF values of XX following 500", "MTF values of YY following 500", "MTF values of XX following 300"], "unit": "re-processing cycles", "qualifier": "standard hospital re-processing", "qualifier_options": ["standard hospital re-processing", "at room temperature", "under typical use"]}];
        const part3Data = [{"chain_id": 1, "device": "Arthroscope", "user_need": "User must be able to visualize structures throughout the shoulder space using one portal access", "design_input": "Scope must come in 0\u00b0, 30\u00b0, and 70\u00b0 tip angles", "design_output": "Scope tip angles: 0\u00b0 \u00b1 1\u00b0, 30\u00b0 \u00b1 2\u00b0, 70\u00b0 \u00b1 2\u00b0 per Drawing SC-045 Rev C", "test_method": "Measure actual viewing angles using optical goniometer per Test Method TM-OPT-12"}, {"chain_id": 2, "device": "Glucose Meter", "user_need": "Patient needs to know glucose level in blood", "design_input": "Device shall measure glucose concentration from 20-600 mg/dL with \u00b115% accuracy", "design_output": "Sensor uses glucose oxidase enzyme on platinum electrode per Drawing GS-001, calibrated per Procedure CAL-123", "test_method": "Accuracy testing using NIST-traceable glucose standards across full range per ISO 15197"}, {"chain_id": 3, "device": "Surgical Screw", "user_need": "Implant device suitable to complete soft tissue repair procedures", "design_input": "Screw shall have minimum 250 N pull-out strength at t=0 in 25D foam", "design_output": "Min. wall thickness = 0.250 in, Pitch = 0.080 in, Length = 1.025 \u00b1 0.010 in, Material: PEEK per Drawing SCR-103", "test_method": "Pull-out testing in 25D polyurethane foam block per ASTM F543, n=30 samples"}, {"chain_id": 4, "device": "Sterile Packaging", "user_need": "Product must be provided ready for surgery", "design_input": "Product shall demonstrate sterility assurance level of 10^-6 per ANSI/AAMI ST67:2003", "design_output": "Ethylene oxide sterilization at 50\u00b0C, 600 mg/L for 2 hours per SOP-STER-045", "test_method": "Biological indicator validation with Bacillus atrophaeus spores, D-value and overkill studies per ISO 11135"}, {"chain_id": 5, "device": "Sterile Packaging", "user_need": "Product must be provided ready for surgery", "design_input": "Packaging seal strength shall be greater than 1 lb", "design_output": "Heat seal: 300\u00b0F, 40 psi, 2 seconds using Tyvek-to-PETG tray per Drawing PKG-201", "test_method": "Seal-strength testing per defined method and sampling plan"}, {"chain_id": 6, "device": "Arthroscope", "user_need": "Device should allow for minimally invasive procedures", "design_input": "Device must have outer diameter of no more than 5 mm", "design_output": "Outer diameter: 4.8 \u00b1 0.1 mm per Drawing ART-100 Rev B, Section A-A", "test_method": "CMM measurement at 3 locations along shaft length, acceptance: 4.7-4.9 mm"}, {"chain_id": 7, "device": "Reusable Instrument", "user_need": "Instruments must be reprocessable to achieve sterility assurance", "design_input": "Device must withstand 500 standard hospital re-processing cycles without loss of function", "design_output": "Material: 17-4 Stainless Steel condition H900 per AMS 5643, all surfaces polished to 32 Ra per Drawing INST-045", "test_method": "Accelerated lifecycle testing: 500 reprocessing cycles, inspect for corrosion/degradation per acceptance criteria in TP-LIFE-08"}, {"chain_id": 8, "device": "Aspiration Handpiece", "user_need": "Handpiece shall maintain a clear field of view throughout surgery", "design_input": "Aspiration socket shall have pull-out force of minimum 10.5 lbs", "design_output": "Apply 0.5g Loctite 242 to socket, minimum interference 0.010 in per Assembly Drawing ASM-301 and Work Instruction WI-ASM-12", "test_method": "Destructive pull test using tensile tester at 10 in/min rate, n=5 per production lot"}, {"chain_id": 9, "device": "Cleaning Validation", "user_need": "Device must have ability to be cleaned by user", "design_input": "Device shall achieve residue levels of no more than 6.4 \u03bcg/cm\u00b2 protein after cleaning per IFU", "design_output": "Internal lumen diameter = 0.5 in, lumen length = 2 in, Material = 17-4 SS, all internal surfaces electropolished per Drawing CLN-089", "test_method": "Worst-case soil study with artificial test soil, clean per IFU, extract and test protein residue using BCA assay per Validation Protocol VP-CLN-04"}, {"chain_id": 10, "device": "Arthroscope Camera", "user_need": "Camera system must be suitable for arthroscopic surgery", "design_input": "Autoclavable camera shall provide an image with MTF values of XX following 500 standard re-processing cycles", "design_output": "Lens assembly: 3-element apochromat design per Drawing CAM-LENS-08, AR coating spec OPT-COAT-12, housing seal: O-ring per AS568-012", "test_method": "Measure MTF using a defined optical bench method before and after 500 standard re-processing cycles"}, {"chain_id": 11, "device": "Arthroscope", "user_need": "Device should provide clear visualization of the surgical area", "design_input": "Device must provide a 30-degree field of view at 10 mm working distance", "design_output": "Objective lens focal length: 2.8 mm \u00b1 0.05 mm, aperture: f/3.5, working distance: 10 mm per Drawing LENS-302", "test_method": "Field of view measurement using calibrated test target at 10 mm distance, measure angular FOV with protractor fixture per TM-OPT-15"}, {"chain_id": 12, "device": "Arthroscope", "user_need": "Device should enable access to small anatomical spaces without tissue damage", "design_input": "Device must withstand force of 10 Newtons without permanent deformation", "design_output": "Outer tube: 304 SS, wall thickness 0.020 in \u00b1 0.002 in, hardness Rockwell B 85-95 per Drawing TUBE-402", "test_method": "Three-point bend test: apply 10N load at midpoint of 100mm span, measure deflection and permanent set per Test Protocol TP-MECH-22"}];

        let sessionData = { part1: [], part2: [], part3: [] };
        let errorCounts = { part1: 0, part2: 0, part3: 0 };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.textContent.includes(screenId === 'home' ? 'Home' : 
                    screenId === 'part1' ? 'Sorting' : 
                    screenId === 'part2' ? 'Build' : 'Trace')) {
                    btn.classList.add('active');
                }
            });

            if (screenId === 'part1' && !window.part1Initialized) initPart1();
            else if (screenId === 'part2' && !window.part2Initialized) initPart2();
            else if (screenId === 'part3' && !window.part3Initialized) initPart3();
        }

        function updateErrorCount(part, increment = true) {
            if (increment) errorCounts[part]++;
            const badge = document.getElementById(`errors-${part}`);
            badge.textContent = `${errorCounts[part]} ‚úó`;
            badge.style.display = errorCounts[part] > 0 ? 'block' : 'none';
        }

        function resetErrorCount(part) {
            errorCounts[part] = 0;
            const badge = document.getElementById(`errors-${part}`);
            badge.style.display = 'none';
        }

        function initPart1() {
            const byCategory = {
                'User Need': part1Data.filter(d => d.category === 'User Need'),
                'Design Input': part1Data.filter(d => d.category === 'Design Input'),
                'Design Output': part1Data.filter(d => d.category === 'Design Output')
            };

            sessionData.part1 = [];
            for (let cat in byCategory) {
                const shuffled = byCategory[cat].sort(() => Math.random() - 0.5);
                sessionData.part1.push(...shuffled.slice(0, 4));
            }

            const pool = document.getElementById('card-pool');
            pool.innerHTML = '';
            sessionData.part1.sort(() => Math.random() - 0.5).forEach(item => {
                const card = document.createElement('div');
                card.className = 'statement-card';
                card.draggable = true;
                card.textContent = item.statement;
                card.dataset.id = item.id;
                card.dataset.category = item.category;
                card.ondragstart = drag;
                pool.appendChild(card);
            });

            document.querySelectorAll('.bucket-cards').forEach(b => b.innerHTML = '');
            document.getElementById('completion-status').classList.remove('show');
            document.getElementById('check-btn').disabled = false;

            window.part1Initialized = true;
        }

        function drag(ev) {
            ev.dataTransfer.setData('cardId', ev.target.dataset.id);
            ev.target.classList.add('dragging');
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');

            const cardId = ev.dataTransfer.getData('cardId');
            const card = document.querySelector(`[data-id="${cardId}"]`);

            if (card) {
                card.classList.remove('dragging', 'correct', 'incorrect');

                let dropZone = ev.target;
                while (dropZone && !dropZone.classList.contains('bucket')) {
                    dropZone = dropZone.parentElement;
                }

                if (dropZone) {
                    const bucketCards = dropZone.querySelector('.bucket-cards');
                    bucketCards.appendChild(card);
                    checkCompletion();
                }
            }
        }

        function checkCompletion() {
            const poolCards = document.getElementById('card-pool').children.length;
            const status = document.getElementById('completion-status');

            if (poolCards === 0) {
                status.textContent = '‚úÖ All cards placed! Click "Check My Work" to see your results.';
                status.classList.add('show');
                document.getElementById('check-btn').disabled = false;
            } else {
                status.textContent = `üìã ${poolCards} cards remaining - place all cards to check answers`;
                status.classList.add('show');
                document.getElementById('check-btn').disabled = true;
            }
        }

        function checkSorting() {
            const poolCards = document.getElementById('card-pool').children.length;
            if (poolCards > 0) {
                alert('Please place all cards in buckets before checking!');
                return;
            }

            let correct = 0, incorrect = 0;

            document.querySelectorAll('.statement-card').forEach(card => {
                const currentBucket = card.closest('.bucket');
                if (currentBucket) {
                    const bucketCategory = currentBucket.dataset.category;
                    const correctCategory = card.dataset.category;

                    if (bucketCategory === correctCategory) {
                        card.classList.add('correct');
                        card.classList.remove('incorrect');
                        correct++;
                    } else {
                        card.classList.add('incorrect');
                        card.classList.remove('correct');
                        incorrect++;
                    }
                }
            });

            if (incorrect > 0) updateErrorCount('part1');

            if (incorrect === 0) {
                updateProgress('part1', 'complete');
                document.getElementById('completion-status').textContent = 
                    `üéâ Perfect! All 12 statements correctly sorted!`;
            } else {
                updateProgress('part1', 'in-progress');
                document.getElementById('completion-status').textContent = 
                    `${correct} correct, ${incorrect} incorrect. Red cards need to be moved.`;
            }
        }

        function showAnswer() {
            sessionData.part1.forEach(item => {
                const card = document.querySelector(`[data-id="${item.id}"]`);
                const targetBucket = document.getElementById(`bucket-${item.category.toLowerCase().replace(' ', '-')}`);
                if (card && targetBucket) {
                    card.classList.add('correct');
                    card.classList.remove('incorrect');
                    targetBucket.appendChild(card);
                }
            });
            document.getElementById('completion-status').textContent = 'üí° Correct answers shown!';
            document.getElementById('completion-status').classList.add('show');
            updateProgress('part1', 'complete');
        }

        function resetSorting() {
            window.part1Initialized = false;
            resetErrorCount('part1');
            initPart1();
            updateProgress('part1', 'not-started');
        }

        let currentChallengeIndex = 0;

        function initPart2() {
            const shuffled = [...part2Data].sort(() => Math.random() - 0.5);
            sessionData.part2 = shuffled.slice(0, 4);
            currentChallengeIndex = 0;
            renderChallenge(0);
            window.part2Initialized = true;
        }

        function renderChallenge(index) {
            currentChallengeIndex = index;
            const challenge = sessionData.part2[index];
            const container = document.getElementById('challenge-container');

            // Build dropdown options from session challenges
            const subjectOptions = [...new Set(sessionData.part2.map(c => c.subject))];
            const actionVerbOptions = [...new Set(sessionData.part2.map(c => c.action_verb))];
            const unitOptions = [...new Set(sessionData.part2.map(c => c.unit))];

            container.innerHTML = `
                <div class="challenge-header">
                    <h3>Challenge ${index + 1} of ${sessionData.part2.length}: ${challenge.device_context}</h3>
                    <div class="user-need">
                        <strong>User Need:</strong> "${challenge.user_need}"
                    </div>
                </div>

                <div class="builder-form">
                    <div class="form-group">
                        <div class="form-label">Subject</div>
                        <select id="subject">
                            <option value="">Select subject...</option>
                            ${subjectOptions.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Action Verb</div>
                        <select id="action-verb">
                            <option value="">Select action...</option>
                            ${actionVerbOptions.map(v => `<option value="${v}">${v}</option>`).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Quantifier</div>
                        <div class="options-group">
                            ${challenge.quantifier_options.map((opt, i) => `
                                <label class="option-item">
                                    <input type="radio" name="quantifier" value="${opt}">
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Unit</div>
                        <select id="unit">
                            <option value="">Select unit...</option>
                            ${unitOptions.map(u => `<option value="${u}">${u}</option>`).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Qualifier / Condition</div>
                        <div class="options-group">
                            ${challenge.qualifier_options.map((opt, i) => `
                                <label class="option-item">
                                    <input type="radio" name="qualifier" value="${opt}">
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="built-requirement" id="built-requirement">
                    <em style="color: #a0aec0;">Your requirement will appear here as you build it...</em>
                </div>

                <div class="feedback" id="feedback"></div>

                <div class="challenge-nav">
                    <div class="nav-buttons">
                        ${index > 0 ? 
                            `<button class="btn btn-secondary" onclick="renderChallenge(${index - 1})">‚Üê Back</button>` : 
                            `<button class="btn btn-secondary" onclick="renderChallenge(${index})" disabled style="opacity:0.5">‚Üê Back</button>`
                        }
                        ${index < sessionData.part2.length - 1 ? 
                            `<button class="btn btn-secondary" onclick="renderChallenge(${index + 1})">Forward ‚Üí</button>` : 
                            `<button class="btn btn-secondary" onclick="renderChallenge(${index})" disabled style="opacity:0.5">Forward ‚Üí</button>`
                        }
                    </div>
                    <span class="challenge-progress">Challenge ${index + 1} of ${sessionData.part2.length}</span>
                    <div class="nav-buttons">
                        <button class="btn btn-primary" onclick="checkRequirement()">‚úì Check Answer</button>
                        <button class="btn btn-warning" onclick="showCorrectRequirement()">üí° Show Answer</button>
                    </div>
                </div>
            `;

            ['subject', 'action-verb', 'unit'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateRequirementPreview);
            });

            document.querySelectorAll('input[name="quantifier"], input[name="qualifier"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    this.closest('.option-item').parentElement.querySelectorAll('.option-item').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.closest('.option-item').classList.add('selected');
                    updateRequirementPreview();
                });
            });
        }

        function updateRequirementPreview() {
            const subject = document.getElementById('subject').value;
            const actionVerb = document.getElementById('action-verb').value;
            const quantifier = document.querySelector('input[name="quantifier"]:checked')?.value || '';
            const unit = document.getElementById('unit').value;
            const qualifier = document.querySelector('input[name="qualifier"]:checked')?.value || '';

            const preview = document.getElementById('built-requirement');

            if (subject || actionVerb) {
                const parts = [subject, 'shall', actionVerb, quantifier, unit, qualifier].filter(p => p);
                preview.innerHTML = parts.join(' ');
            } else {
                preview.innerHTML = '<em style="color: #a0aec0;">Your requirement will appear here as you build it...</em>';
            }
        }

        function checkRequirement() {
            const challenge = sessionData.part2[currentChallengeIndex];
            const subject = document.getElementById('subject').value;
            const actionVerb = document.getElementById('action-verb').value;
            const quantifier = document.querySelector('input[name="quantifier"]:checked')?.value || '';
            const unit = document.getElementById('unit').value;
            const qualifier = document.querySelector('input[name="qualifier"]:checked')?.value || '';

            const feedback = document.getElementById('feedback');

            if (!subject || !actionVerb || !quantifier || !unit || !qualifier) {
                feedback.className = 'feedback error show';
                feedback.textContent = '‚ùå All fields are required. Please complete all selections.';
                return;
            }

            const isCorrect = (
                subject === challenge.subject &&
                actionVerb === challenge.action_verb &&
                quantifier === challenge.quantifier &&
                unit === challenge.unit &&
                qualifier === challenge.qualifier
            );

            if (isCorrect) {
                feedback.className = 'feedback success show';
                feedback.innerHTML = `‚úÖ <strong>Perfect!</strong> You've constructed the correct requirement:<br><br>"${challenge.correct_design_input}"`;
                updateProgress('part2', 'in-progress');
            } else {
                updateErrorCount('part2');
                feedback.className = 'feedback error show';
                feedback.innerHTML = `‚ùå Not quite right. Review your selections and try again, or click "Show Answer".`;
            }
        }

        function showCorrectRequirement() {
            const challenge = sessionData.part2[currentChallengeIndex];
            document.getElementById('subject').value = challenge.subject;
            document.getElementById('action-verb').value = challenge.action_verb;
            document.getElementById('unit').value = challenge.unit;

            document.querySelectorAll('input[name="quantifier"]').forEach(radio => {
                if (radio.value === challenge.quantifier) {
                    radio.checked = true;
                    radio.closest('.option-item').classList.add('selected');
                }
            });

            document.querySelectorAll('input[name="qualifier"]').forEach(radio => {
                if (radio.value === challenge.qualifier) {
                    radio.checked = true;
                    radio.closest('.option-item').classList.add('selected');
                }
            });

            updateRequirementPreview();

            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback success show';
            feedback.innerHTML = `üí° <strong>Correct answer shown:</strong><br>"${challenge.correct_design_input}"`;
            updateProgress('part2', 'in-progress');
        }

        let selectedCard = null;
        let linkedCards = new Set();
        let completedChains = [];
        let chainLinks = {};

        function initPart3() {
            const shuffled = [...part3Data].sort(() => Math.random() - 0.5);
            sessionData.part3 = shuffled.slice(0, 3);

            const grid = document.getElementById('trace-grid');
            grid.innerHTML = `
                <div class="trace-column need">
                    <h4>User Needs</h4>
                    <div class="trace-cards-col" id="col-need"></div>
                </div>
                <div class="trace-column input">
                    <h4>Design Inputs</h4>
                    <div class="trace-cards-col" id="col-input"></div>
                </div>
                <div class="trace-column output">
                    <h4>Design Outputs</h4>
                    <div class="trace-cards-col" id="col-output"></div>
                </div>
                <div class="trace-column test">
                    <h4>Test Methods</h4>
                    <div class="trace-cards-col" id="col-test"></div>
                </div>
            `;

            const allCards = [];
            sessionData.part3.forEach(chain => {
                allCards.push({chainId: chain.chain_id, type: 'need', text: chain.user_need, device: chain.device});
                allCards.push({chainId: chain.chain_id, type: 'input', text: chain.design_input, device: chain.device});
                allCards.push({chainId: chain.chain_id, type: 'output', text: chain.design_output, device: chain.device});
                allCards.push({chainId: chain.chain_id, type: 'test', text: chain.test_method, device: chain.device});
            });

            ['need', 'input', 'output', 'test'].forEach(type => {
                const cards = allCards.filter(c => c.type === type).sort(() => Math.random() - 0.5);
                const container = document.getElementById(`col-${type}`);
                cards.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'trace-card';
                    cardEl.dataset.chainId = card.chainId;
                    cardEl.dataset.type = type;
                    cardEl.dataset.index = `${type}-${index}`;
                    cardEl.textContent = card.text;
                    cardEl.onclick = () => selectTraceCard(cardEl);
                    container.appendChild(cardEl);
                });
            });

            document.getElementById('completed-chains').innerHTML = '';
            document.getElementById('chains-count').textContent = '0';
            completedChains = [];
            linkedCards.clear();
            selectedCard = null;
            chainLinks = {};

            window.part3Initialized = true;
        }

        function selectTraceCard(cardEl) {
            if (linkedCards.has(cardEl.dataset.index)) return;

            if (!selectedCard) {
                selectedCard = cardEl;
                cardEl.classList.add('selected');
            } else {
                if (selectedCard === cardEl) {
                    selectedCard.classList.remove('selected');
                    selectedCard = null;
                    return;
                }

                if (selectedCard.dataset.chainId === cardEl.dataset.chainId) {
                    selectedCard.classList.remove('selected');
                    selectedCard.classList.add('correct-link');
                    cardEl.classList.add('correct-link');

                    if (!chainLinks[cardEl.dataset.chainId]) {
                        chainLinks[cardEl.dataset.chainId] = [];
                    }
                    chainLinks[cardEl.dataset.chainId].push(selectedCard.dataset.index, cardEl.dataset.index);

                    checkChainComplete(cardEl.dataset.chainId);
                } else {
                    updateErrorCount('part3');
                    selectedCard.classList.add('incorrect');
                    cardEl.classList.add('incorrect');
                    setTimeout(() => {
                        selectedCard.classList.remove('incorrect', 'selected');
                        cardEl.classList.remove('incorrect');
                    }, 600);
                }

                selectedCard = null;
            }
        }

        function checkChainComplete(chainId) {
            const uniqueLinks = new Set(chainLinks[chainId] || []);

            if (uniqueLinks.size === 4) {
                // Chain is complete - now gray out all cards
                uniqueLinks.forEach(idx => {
                    const card = document.querySelector(`[data-index="${idx}"]`);
                    if (card) {
                        card.classList.add('linked');
                        linkedCards.add(idx);
                    }
                });

                const chain = sessionData.part3.find(c => c.chain_id == chainId);
                completedChains.push(chain);

                const completedArea = document.getElementById('completed-chains');
                const chainEl = document.createElement('div');
                chainEl.className = 'completed-chain';
                chainEl.innerHTML = `
                    <div class="chain-device">‚úÖ ${chain.device}</div>
                    <div style="font-size: 13px; color: #22543d; font-weight: 600;">Complete traceability chain established</div>
                `;
                completedArea.appendChild(chainEl);

                document.getElementById('chains-count').textContent = completedChains.length;

                document.getElementById('modal-text').textContent = 
                    `You've successfully traced the ${chain.device} from clinical need through to verification testing!`;
                document.getElementById('chain-modal').classList.add('show');

                updateProgress('part3', completedChains.length === 3 ? 'complete' : 'in-progress');
            }
        }

        function closeModal() {
            document.getElementById('chain-modal').classList.remove('show');
        }

        function resetTraceMatrix() {
            window.part3Initialized = false;
            resetErrorCount('part3');
            initPart3();
            updateProgress('part3', 'not-started');
        }

        function updateProgress(part, status) {
            const badge = document.getElementById(`progress-${part}`);
            badge.className = `progress-badge ${status}`;
            badge.textContent = status === 'complete' ? 'Complete' : 
                               status === 'in-progress' ? 'In Progress' : 'Not Started';
        }
    </script>
</body>
</html>
